<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NanoBanana Renderer</title>
  <link rel="stylesheet" href="styles/main-base.css">
  <link rel="stylesheet" href="styles/main-render.css">
  <link rel="stylesheet" href="styles/main-mix.css">
  <link rel="stylesheet" href="styles/main-node-editor.css">
</head>
<body>
  <!-- ì´ˆê¸° ë¡œë”© í™”ë©´ -->
  <div class="app-loader" id="app-loader">
    <div class="app-loader-logo">Nano<span>Banana</span></div>
    <div class="app-loader-spinner"></div>
    <div class="app-loader-text">Loading renderer...</div>
  </div>

  <!-- ì¢Œì¸¡ ì•„ì´ì½˜ ë©”ë‰´ë°” -->
  <nav class="icon-menu">
    <button class="icon-menu-item active" id="menu-render" title="Render">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M.968 9.027l7.717 4.428-.006 1.32-4.39-2.518-2.763 1.57 7.148 4.12.005 1.27-7.658-4.405c.02.516.488 2.106 1.383 3.337.91 1.247 1.946 1.776 1.946 1.776L11.428 24V11.849L.975 5.846zm22.064-3.8L15.22.723S13.982 0 12.008 0C9.952 0 8.76.746 8.76.746l-7.236 4.14 11.009 6.328V24l7.245-4.136s1.295-.715 2.279-2.414c.867-1.496.975-2.943.975-2.943zM11.251 7.308s1.615-.298 2.98.49l2.171 1.25s.003 1.097.003 2.736c0 1.313-1.112 2.674-1.112 2.674l.002-4.816zm6.402 10.562l-2.358 1.353v-1.269l1.835-1.05c1.748-1.26 2.037-3.117 2.037-3.761l-.007-5.705-5.006-2.881s-.76-.499-2.129-.499c-1.367 0-2.113.461-2.113.461L8.154 5.53l-1.11-.641L9.473 3.5s.95-.527 2.544-.527c1.462 0 2.6.571 2.6.571L20.27 6.81l-.007 6.226c.04.957-.406 3.296-2.61 4.835z"/>
      </svg>
    </button>
    <button class="icon-menu-item" id="menu-camera" title="Camera">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M18 3C19.6569 3 21 4.34315 21 6C21 7.65685 19.6569 9 18 9H15C13.6941 9 12.5831 8.16562 12.171 7.0009L11 7C9.9 7 9 7.9 9 9L9.0009 9.17102C10.1656 9.58312 11 10.6941 11 12C11 13.3059 10.1656 14.4169 9.0009 14.829L9 15C9 16.1 9.9 17 11 17L12.1707 17.0001C12.5825 15.8349 13.6937 15 15 15H18C19.6569 15 21 16.3431 21 18C21 19.6569 19.6569 21 18 21H15C13.6941 21 12.5831 20.1656 12.171 19.0009L11 19C8.79 19 7 17.21 7 15H5C3.34315 15 2 13.6569 2 12C2 10.3431 3.34315 9 5 9H7C7 6.79086 8.79086 5 11 5L12.1707 5.00009C12.5825 3.83485 13.6937 3 15 3H18ZM18 17H15C14.4477 17 14 17.4477 14 18C14 18.5523 14.4477 19 15 19H18C18.5523 19 19 18.5523 19 18C19 17.4477 18.5523 17 18 17ZM8 11H5C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13H8C8.55228 13 9 12.5523 9 12C9 11.4477 8.55228 11 8 11ZM18 5H15C14.4477 5 14 5.44772 14 6C14 6.55228 14.4477 7 15 7H18C18.5523 7 19 6.55228 19 6C19 5.44772 18.5523 5 18 5Z"/>
      </svg>
    </button>
    <button class="icon-menu-item" id="menu-mix" title="Mix">
      <svg viewBox="0 0 15 15" fill="currentColor">
        <path d="M1.59979 8.82434C1.59991 8.32473 2.10284 7.99678 2.54999 8.17004L2.63885 8.21204L6.57245 10.3878L6.65741 10.4425C7.02571 10.7193 7.02591 11.282 6.65741 11.5587L6.57245 11.6134L2.63885 13.7892C2.17257 14.0469 1.60035 13.7095 1.59979 13.1769V8.82434ZM13.0002 8.29993C13.3867 8.30002 13.7004 8.61358 13.7004 9.00012V13.0001C13.7003 13.3866 13.3867 13.7002 13.0002 13.7003H9.00018C8.61362 13.7003 8.30004 13.3867 8.29999 13.0001V9.00012C8.29999 8.61352 8.61358 8.29993 9.00018 8.29993H13.0002ZM2.50018 12.8361L5.81952 11.0001L2.50018 9.16321V12.8361ZM9.20038 12.7999H12.8V9.20032H9.20038V12.7999ZM4.00018 1.24915C5.51931 1.24925 6.75114 2.48097 6.75116 4.00012C6.75105 5.5192 5.51926 6.75099 4.00018 6.7511C2.48103 6.75108 1.24931 5.51925 1.24921 4.00012C1.24922 2.48091 2.48098 1.24916 4.00018 1.24915ZM12.8068 1.55676C12.9826 1.38103 13.2678 1.38103 13.4435 1.55676C13.6191 1.73251 13.6192 2.01781 13.4435 2.19348L11.6369 4.00012L13.4435 5.80676L13.5012 5.87708C13.6165 6.05174 13.5973 6.2897 13.4435 6.44348C13.2898 6.59725 13.0518 6.61646 12.8771 6.5011L12.8068 6.44348L11.0002 4.63684L9.19354 6.44348C9.01787 6.61913 8.73257 6.61902 8.55682 6.44348C8.38109 6.26775 8.38111 5.9825 8.55682 5.80676L10.3635 4.00012L8.55682 2.19348L8.49921 2.12317C8.38371 1.94849 8.403 1.7106 8.55682 1.55676C8.71066 1.40293 8.94854 1.38364 9.12323 1.49915L9.19354 1.55676L11.0002 3.3634L12.8068 1.55676ZM4.00018 2.14954C2.97803 2.14955 2.14961 2.97797 2.1496 4.00012C2.1497 5.0222 2.97809 5.85069 4.00018 5.85071C5.0222 5.8506 5.85066 5.02214 5.85077 4.00012C5.85075 2.97803 5.02226 2.14964 4.00018 2.14954Z"/>
      </svg>
    </button>
    <button class="icon-menu-item" id="menu-history" title="History">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    </button>
    <div class="icon-menu-divider"></div>
    <div class="icon-menu-spacer"></div>
    <button class="icon-menu-item" id="menu-help" title="Help">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
    </button>
    <button class="icon-menu-item" id="menu-settings" title="Settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>
  </nav>

  <!-- Mix ëª¨ë“œ ì¢Œì¸¡ íŒ¨ë„ -->
  <aside class="mix-mode-panel" id="mix-mode-panel">
    <div class="mix-mode-header">
      <div class="mix-mode-title">Mix Mode</div>
      <div class="mix-mode-subtitle">AI Scene Mixing System</div>
    </div>
    <div class="mix-mode-list">
      <div class="mix-mode-item active" data-mixmode="add-remove">
        <div class="mix-mode-item-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="16"></line>
            <line x1="8" y1="12" x2="16" y2="12"></line>
          </svg>
          Object Insert & Remove
          <span class="mix-mode-item-badge">3D</span>
        </div>
        <div class="mix-mode-item-desc">3D ì›”ë“œ ì¢Œí‘œ ê¸°ë°˜ìœ¼ë¡œ ê°€êµ¬/ì†Œí’ˆì„ ì •í™•í•œ ìœ„ì¹˜ì— ë°°ì¹˜í•˜ê±°ë‚˜ ì œê±°í•©ë‹ˆë‹¤.</div>
      </div>
      <div class="mix-mode-item" data-mixmode="inpaint">
        <div class="mix-mode-item-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
          </svg>
          Inpainting
        </div>
        <div class="mix-mode-item-desc">ë§ˆìŠ¤í‚¹ ì˜ì—­ë§Œ ìˆ˜ì •í•˜ê³  ë‚˜ë¨¸ì§€ ì”¬ì€ í”½ì…€ ë‹¨ìœ„ê¹Œì§€ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.</div>
      </div>
      <div class="mix-mode-item" data-mixmode="material">
        <div class="mix-mode-item-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
          Material Replace
        </div>
        <div class="mix-mode-item-desc">ë²½/ë°”ë‹¥/ì²œì¥ì— ìƒˆë¡œìš´ ì¬ì§ˆì„ ì‹¤ì œ ê³µê°„ì— ë§ê²Œ íˆ¬ì˜í•©ë‹ˆë‹¤.</div>
      </div>
      <div class="mix-mode-item" data-mixmode="floorplan">
        <div class="mix-mode-item-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
            <line x1="8" y1="2" x2="8" y2="18"></line>
            <line x1="16" y1="6" x2="16" y2="22"></line>
          </svg>
          Floorplan to Isometric
        </div>
        <div class="mix-mode-item-desc">2D í‰ë©´ë„ë¥¼ ë¶„ì„í•˜ì—¬ 3D ì•„ì´ì†Œë©”íŠ¸ë¦­ ë·°ë¡œ ìë™ ë³€í™˜í•©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </aside>

  <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
  <aside class="sidebar" id="render-sidebar">
    <div class="sidebar-header">
      <div class="logo">NanoBanana</div>
    </div>

    <div class="sidebar-content">
      <div class="control-section">
        <span class="section-label">Time</span>
        <div class="segmented" id="time-group">
          <button class="seg-btn active" data-time="day">Day</button>
          <button class="seg-btn" data-time="evening">Eve</button>
          <button class="seg-btn" data-time="night">Night</button>
        </div>
      </div>

      <div class="control-section">
        <span class="section-label">Lights</span>
        <div class="segmented" id="light-group">
          <button class="seg-btn active" data-light="on">On</button>
          <button class="seg-btn" data-light="off">Off</button>
        </div>
      </div>

      <div class="control-section">
        <span class="section-label">Engine</span>
        <div class="segmented" id="engine-group">
          <button class="seg-btn active" data-engine="gemini">Gemini</button>
          <button class="seg-btn" data-engine="replicate">Replicate</button>
        </div>
      </div>

      <div class="control-section">
        <span class="section-label">Model</span>
        <div class="custom-dropdown" id="model-dropdown">
          <div class="dropdown-selected" id="model-dropdown-selected">
            <span id="model-selected-text">Flash 2.0 (ì¶”ì²œ)</span>
            <span class="dropdown-arrow"></span>
          </div>
          <div class="dropdown-menu" id="model-dropdown-menu">
            <div class="dropdown-group-label">Gemini</div>
            <div class="dropdown-item selected" data-value="gemini-2.0-flash-exp" data-engine="gemini">
              Flash 2.0 (ì¶”ì²œ)
              <div class="dropdown-item-desc">20~40ì´ˆ, ê³ ì†</div>
            </div>
            <div class="dropdown-item" data-value="gemini-2.5-flash-image" data-engine="gemini">
              Flash 2.5
              <div class="dropdown-item-desc">30~60ì´ˆ</div>
            </div>
            <div class="dropdown-item" data-value="gemini-3-pro-image" data-engine="gemini">
              Gemini 3 Pro
              <div class="dropdown-item-desc">1~2ë¶„, ìµœê³ í’ˆì§ˆ</div>
            </div>
            <div class="dropdown-group-label">Imagen</div>
            <div class="dropdown-item" data-value="imagen-4.0-fast-generate-001" data-engine="gemini">
              Imagen 4 Fast
              <div class="dropdown-item-desc">20~40ì´ˆ, ê³ ì†</div>
            </div>
            <div class="dropdown-item" data-value="imagen-4.0-generate-001" data-engine="gemini">
              Imagen 4
              <div class="dropdown-item-desc">1~2ë¶„, ê³ í’ˆì§ˆ</div>
            </div>
            <div class="dropdown-group-label">Replicate (ControlNet)</div>
            <div class="dropdown-item" data-value="photorealistic-fx" data-engine="replicate">
              PhotoFX
              <div class="dropdown-item-desc">10ì´ˆ, êµ¬ë„ ìœ ì§€</div>
            </div>
            <div class="dropdown-item" data-value="sdxl-controlnet" data-engine="replicate">
              SDXL ControlNet
              <div class="dropdown-item-desc">20ì´ˆ, ê³ í’ˆì§ˆ</div>
            </div>
            <div class="dropdown-item" data-value="flux-canny" data-engine="replicate">
              Flux Canny
              <div class="dropdown-item-desc">15ì´ˆ, ìœ¤ê³½ì„  ê¸°ë°˜</div>
            </div>
          </div>
        </div>
      </div>

      <div class="control-section">
        <span class="section-label">Size</span>
        <div class="segmented" id="size-group">
          <button class="seg-btn active" data-size="1024">ì†ë„</button>
          <button class="seg-btn" data-size="1536">ë°¸ëŸ°ìŠ¤</button>
          <button class="seg-btn" data-size="1920">ê³ í’ˆì§ˆ</button>
        </div>
      </div>

      <div class="control-section">
        <span class="section-label">Camera</span>
        <div class="camera-btns-row">
          <button class="btn btn-mirror" id="btn-mirror">Mirror</button>
          <button class="btn btn-2point" id="btn-2point" title="2ì  íˆ¬ì‹œ ìë™ ë³´ì •">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <line x1="12" y1="3" x2="12" y2="21"/>
              <line x1="3" y1="12" x2="21" y2="12"/>
            </svg>
          </button>
        </div>
        <div class="camera-controls">
          <div class="camera-move">
            <div class="move-row">
              <button class="cam-btn wasd" id="cam-forward" title="Forward (W)">W</button>
            </div>
            <div class="move-row">
              <button class="cam-btn wasd" id="cam-left" title="Left (A)">A</button>
              <button class="cam-btn wasd" id="cam-back" title="Back (S)">S</button>
              <button class="cam-btn wasd" id="cam-right" title="Right (D)">D</button>
            </div>
          </div>
          <div class="camera-height">
            <button class="cam-btn small" id="cam-up" title="Up (Q)">Q</button>
            <button class="cam-btn small" id="cam-down" title="Down (E)">E</button>
          </div>
          <div class="camera-rotate">
            <button class="cam-btn small" id="cam-rot-left" title="Rotate Left (Z)">Z</button>
            <button class="cam-btn small" id="cam-rot-right" title="Rotate Right (X)">X</button>
          </div>
        </div>
        <div class="keyboard-hint">WASD ì´ë™ | QE ë†’ì´ | ZX íšŒì „</div>
      </div>

      <div class="control-section">
        <span class="section-label">Height</span>
        <div class="segmented" id="height-group">
          <button class="seg-btn" data-height="standing">ì„œê¸°</button>
          <button class="seg-btn active" data-height="seated">ì•‰ê¸°</button>
          <button class="seg-btn" data-height="low_angle">ë‚®ìŒ</button>
        </div>
      </div>

      <div class="control-section">
        <span class="section-label">FOV</span>
        <div class="segmented" id="fov-group">
          <button class="seg-btn" data-fov="wide">ê´‘ê°</button>
          <button class="seg-btn active" data-fov="standard">í‘œì¤€</button>
          <button class="seg-btn" data-fov="telephoto">ë§ì›</button>
        </div>
      </div>
    </div>

    <div class="sidebar-actions">
      <button class="btn btn-secondary" id="btn-capture">Convert</button>
      <button class="btn btn-secondary" id="btn-edit" disabled>Edit</button>
      <button class="btn btn-secondary" id="btn-save" disabled>Export</button>
    </div>

    <div class="sidebar-footer">
      <div class="status-indicator">
        <span class="status-dot" id="status-dot"></span>
        <span id="api-status">Checking...</span>
      </div>
      <button class="icon-btn" id="btn-settings" title="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
      </button>
    </div>
  </aside>

  <!-- Mix ì˜µì…˜ íŒ¨ë„ (ìš°ì¸¡) -->
  <aside class="mix-options-panel" id="mix-options-panel">
    <div class="mix-options-header">
      <div class="mix-options-title" id="mix-options-title">Object Insert & Remove</div>
      <div class="mix-options-subtitle" id="mix-options-subtitle">3D ì¢Œí‘œ ê¸°ë°˜ ì˜¤ë¸Œì íŠ¸ ë°°ì¹˜</div>
    </div>

    <div class="mix-options-content">
      <!-- Add/Remove ì˜µì…˜ -->
      <div class="mix-options-mode" id="mix-options-add-remove">
        <div class="mix-option-section">
          <span class="mix-option-label">
            Reference Image
            <span class="mix-option-label-badge">Required</span>
          </span>
          <div class="mix-upload-area" id="mix-upload-object">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <p>Click to upload furniture/object image</p>
            <img class="mix-upload-preview hidden" id="mix-object-preview">
          </div>
          <input type="file" id="mix-object-file" accept="image/*" style="display:none">
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Object Name</span>
          <input type="text" class="mix-option-input" id="mix-object-name" placeholder="e.g., Modern Dining Chair">
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Estimated Size (mm)</span>
          <div class="mix-param-grid">
            <div class="mix-param-item">
              <label>Width</label>
              <input type="number" id="mix-object-width" value="500" min="100" max="5000">
            </div>
            <div class="mix-param-item">
              <label>Height</label>
              <input type="number" id="mix-object-height" value="800" min="100" max="5000">
            </div>
            <div class="mix-param-item">
              <label>Depth</label>
              <input type="number" id="mix-object-depth" value="500" min="100" max="5000">
            </div>
          </div>
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Placement Instructions</span>
          <textarea class="mix-option-textarea" id="mix-object-instruction" placeholder="e.g., Place naturally on the floor, facing the window."></textarea>
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Hotspots (3D Positions)</span>
          <div class="mix-hotspot-list" id="mix-hotspot-list">
            <div class="mix-empty-state" style="font-size:11px;padding:16px;color:#555;">
              ìŠ¤ì¼€ì¹˜ì—… ë·°í¬íŠ¸ì—ì„œ í´ë¦­í•˜ì—¬ í•«ìŠ¤íŒŸì„ ì¶”ê°€í•˜ì„¸ìš”
            </div>
          </div>
        </div>
      </div>

      <!-- Inpaint ì˜µì…˜ -->
      <div class="mix-options-mode hidden" id="mix-options-inpaint">
        <div class="mix-option-section">
          <span class="mix-option-label">Brush Size</span>
          <div class="mix-slider-container">
            <input type="range" class="mix-slider" id="mix-brush-size" min="5" max="100" value="30">
            <span class="mix-slider-value" id="mix-brush-size-value">30px</span>
          </div>
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Mask Color</span>
          <div class="mix-color-picker-row">
            <button class="mix-color-btn red active" data-color="rgba(255, 59, 48, 0.5)"></button>
            <button class="mix-color-btn blue" data-color="rgba(0, 102, 255, 0.5)"></button>
            <button class="mix-color-btn green" data-color="rgba(48, 209, 88, 0.5)"></button>
            <button class="mix-color-btn yellow" data-color="rgba(255, 214, 10, 0.5)"></button>
          </div>
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">
            Edit Instruction
            <span class="mix-option-label-badge">Required</span>
          </span>
          <textarea class="mix-option-textarea" id="mix-inpaint-instruction" placeholder="e.g., Change the sofa to a vintage brown leather chesterfield sofa"></textarea>
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Preserve Settings</span>
          <label style="display:flex;align-items:center;gap:8px;font-size:11px;color:#ccc;margin-top:4px;">
            <input type="checkbox" id="mix-preserve-lighting" checked> Lighting & Shadows
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:11px;color:#ccc;margin-top:4px;">
            <input type="checkbox" id="mix-preserve-style" checked> Material Style & Tone
          </label>
        </div>
      </div>

      <!-- Material ì˜µì…˜ -->
      <div class="mix-options-mode hidden" id="mix-options-material">
        <div class="mix-option-section">
          <span class="mix-option-label">Brush Size</span>
          <div class="mix-slider-container">
            <input type="range" class="mix-slider" id="mix-material-brush-size" min="5" max="100" value="40">
            <span class="mix-slider-value" id="mix-material-brush-size-value">40px</span>
          </div>
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">
            Material Texture Image
            <span class="mix-option-label-badge">Required</span>
          </span>
          <div class="mix-upload-area" id="mix-upload-material">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <p>Click to upload material texture</p>
            <img class="mix-upload-preview hidden" id="mix-material-preview">
          </div>
          <input type="file" id="mix-material-file" accept="image/*" style="display:none">
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Material Description</span>
          <textarea class="mix-option-textarea" id="mix-material-description" placeholder="e.g., Herringbone oak wood flooring, natural matte finish"></textarea>
        </div>
      </div>

      <!-- Floorplan ì˜µì…˜ -->
      <div class="mix-options-mode hidden" id="mix-options-floorplan">
        <div class="mix-option-section">
          <span class="mix-option-label">
            2D Floorplan Image
            <span class="mix-option-label-badge">Required</span>
          </span>
          <div class="mix-upload-area" id="mix-upload-floorplan">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <p>Click to upload 2D floorplan (PNG/PDF)</p>
            <img class="mix-upload-preview hidden" id="mix-floorplan-preview">
          </div>
          <input type="file" id="mix-floorplan-file" accept="image/*,.pdf" style="display:none">
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Space Parameters</span>
          <div class="mix-param-grid">
            <div class="mix-param-item">
              <label>Wall Height (mm)</label>
              <input type="number" id="mix-wall-height" value="2400" min="2000" max="5000">
            </div>
            <div class="mix-param-item">
              <label>Wall Thickness (mm)</label>
              <input type="number" id="mix-wall-thickness" value="100" min="50" max="500">
            </div>
          </div>
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Interior Style</span>
          <select class="mix-option-input" id="mix-floorplan-style">
            <option value="modern">Modern Minimalist</option>
            <option value="scandinavian">Scandinavian</option>
            <option value="industrial">Industrial</option>
            <option value="classic">Classic Traditional</option>
            <option value="luxury">Luxury High-End</option>
            <option value="japandi">Japandi</option>
          </select>
        </div>

        <div class="mix-option-section">
          <span class="mix-option-label">Additional Instructions</span>
          <textarea class="mix-option-textarea" id="mix-floorplan-instruction" placeholder="e.g., Add appropriate furniture for each room, warm artificial lighting"></textarea>
        </div>
      </div>
    </div>

    <div class="mix-options-actions">
      <button class="btn btn-primary" id="mix-btn-apply" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Apply Mix
      </button>
      <button class="btn btn-secondary" id="mix-btn-back">Back to Render</button>
    </div>
  </aside>

  <!-- Mix ë©”ì¸ ì‘ì—… ì˜ì—­ -->
  <main class="mix-main-area" id="mix-main-area">
    <div class="mix-toolbar">
      <!-- Add/Remove ëª¨ë“œ íˆ´ë°” -->
      <div class="mix-toolbar-group" id="mix-toolbar-add-remove">
        <button class="mix-tool-btn active" id="mix-tool-hotspot" title="í•«ìŠ¤íŒŸ ì¶”ê°€ (ìŠ¤ì¼€ì¹˜ì—… ë·°ì—ì„œ í´ë¦­)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <line x1="12" y1="2" x2="12" y2="6"></line>
            <line x1="12" y1="18" x2="12" y2="22"></line>
            <line x1="2" y1="12" x2="6" y2="12"></line>
            <line x1="18" y1="12" x2="22" y2="12"></line>
          </svg>
        </button>
        <span class="mix-tool-label">Click on SketchUp viewport to add hotspot</span>
      </div>

      <!-- Inpaint/Material ëª¨ë“œ íˆ´ë°” -->
      <div class="mix-toolbar-group hidden" id="mix-toolbar-mask">
        <button class="mix-tool-btn active" id="mix-tool-brush" title="ë¸ŒëŸ¬ì‹œ">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9.06 11.9l8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"></path>
            <path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"></path>
          </svg>
        </button>
        <button class="mix-tool-btn" id="mix-tool-eraser" title="ì§€ìš°ê°œ">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 20H7L3 16l10-10 7 7-4 4"></path>
          </svg>
        </button>
        <div class="mix-tool-divider"></div>
        <button class="mix-tool-btn" id="mix-tool-clear-mask" title="ë§ˆìŠ¤í¬ ì´ˆê¸°í™”">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
      </div>

      <!-- Floorplan ëª¨ë“œ íˆ´ë°” -->
      <div class="mix-toolbar-group hidden" id="mix-toolbar-floorplan">
        <span class="mix-tool-label">Upload 2D floorplan to generate isometric view</span>
      </div>
    </div>

    <div class="mix-canvas-container">
      <div class="mix-empty-state" id="mix-empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <p>ë¨¼ì € ë©”ì¸ í™”ë©´ì—ì„œ ì”¬ì„ ìº¡ì²˜(Convert)í•˜ì„¸ìš”</p>
        <p style="margin-top:4px;color:#555;">ìº¡ì²˜ í›„ Mix ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
      </div>
      <div class="mix-canvas-wrapper hidden" id="mix-canvas-wrapper">
        <canvas id="mix-main-canvas"></canvas>
        <canvas id="mix-mask-canvas" class="mix-overlay-canvas"></canvas>
        <canvas id="mix-draw-canvas" class="mix-overlay-canvas"></canvas>
      </div>

      <div class="mix-coord-overlay" id="mix-coord-overlay">
        <div>World: <span id="mix-coord-world">X: 0 Y: 0 Z: 0</span></div>
        <div>Screen: <span id="mix-coord-screen">X: 0 Y: 0</span></div>
      </div>

      <div class="mix-loading-overlay hidden" id="mix-loading">
        <div class="spinner"></div>
        <div class="loading-text" id="mix-loading-text">Processing...</div>
        <div class="loading-subtext" id="mix-loading-subtext">AIê°€ ì”¬ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
      </div>
    </div>

    <div class="mix-status-bar">
      <span id="mix-status-text">Ready</span>
      <span id="mix-scene-info">Scene context loaded</span>
    </div>
  </main>

  <!-- ì„¤ì • ë©”ì¸ ì˜ì—­ -->
  <main class="main-area settings-main-area" id="settings-main-area" style="display:none;">
    <div class="settings-container">
      <div class="settings-header">
        <h2>Settings</h2>
        <button class="settings-close-btn" id="btn-close-settings">âœ•</button>
      </div>
      <div class="settings-content">
        <div class="settings-section">
          <label class="settings-label">Google Gemini API Key</label>
          <div class="settings-input-row">
            <input type="password" id="settings-api-key" class="settings-input" placeholder="API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button class="settings-toggle-btn" id="btn-toggle-api-key">ğŸ‘ï¸</button>
          </div>
          <p class="settings-help">API KeyëŠ” <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>ì—ì„œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="settings-section">
          <label class="settings-label">ì—°ê²° ìƒíƒœ</label>
          <div class="settings-status">
            <span class="settings-status-dot" id="settings-status-dot"></span>
            <span id="settings-status-text">í™•ì¸ í•„ìš”</span>
          </div>
          <button class="settings-btn" id="btn-test-api">ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        </div>
        <div class="settings-actions">
          <button class="settings-btn settings-btn-primary" id="btn-save-settings">ì €ì¥</button>
        </div>
      </div>
    </div>
  </main>

  <!-- ìš°ì¸¡ ë©”ì¸ ì˜ì—­ -->
  <main class="main-area" id="render-main-area">
    <!-- ì”¬ íƒ­ ë°” -->
    <div class="scene-tabs" id="scene-tabs">
      <button class="scene-add-btn" id="btn-add-scene" title="í˜„ì¬ ë·°ë¥¼ ì”¬ìœ¼ë¡œ ì €ì¥">+</button>
    </div>

    <div class="image-container" id="image-container">
      <div class="image-panel" id="source-panel">
        <div class="panel-label">
          <span>Source</span>
          <button class="panel-guide-btn" id="btn-guide" title="ê°€ì´ë“œ í‘œì‹œ">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="2" x2="12" y2="22"></line>
              <line x1="2" y1="12" x2="22" y2="12"></line>
            </svg>
          </button>
          <button class="panel-expand-btn" id="btn-expand-source" title="Expand">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 3 21 3 21 9"></polyline>
              <polyline points="9 21 3 21 3 15"></polyline>
              <line x1="21" y1="3" x2="14" y2="10"></line>
              <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
          </button>
        </div>
        <div class="panel-content">
          <div class="empty-state" id="original-empty">No image</div>
          <div class="image-zoom-container" id="zoom-container-source">
            <div class="image-zoom-wrapper" id="zoom-wrapper-source">
              <img id="original-image" style="display:none;">
              <canvas class="guide-grid-canvas" id="guide-canvas-source" style="display:none;"></canvas>
            </div>
          </div>
          <div class="guide-controls hidden" id="guide-controls-source">
            <label>Grid</label>
            <input type="range" class="guide-slider" id="guide-slider-source" min="10" max="100" value="40">
            <span class="guide-value" id="guide-value-source">40px</span>
            <button class="guide-lock-btn" id="guide-lock-source" title="Lock">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
            </button>
            <label style="margin-left:8px;">Zoom</label>
            <input type="range" class="guide-zoom-slider" id="guide-zoom-source" min="50" max="150" value="100">
          </div>
          <div class="loading-overlay hidden" id="loading-source">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text-source">Converting... <span id="loading-percent-source">0%</span></div>
            <div class="loading-subtext" id="loading-subtext-source">Preparing</div>
            <div class="loading-progress"><div class="loading-progress-bar" id="loading-bar-source"></div></div>
          </div>
        </div>
        <div class="prompt-area" id="prompt-area-source">
          <div class="prompt-header">
            <div class="prompt-tabs">
              <button class="prompt-tab active" data-tab="main">Prompt</button>
              <button class="prompt-tab negative" data-tab="negative">Negative</button>
            </div>
            <button class="prompt-auto-btn" id="btn-auto-prompt" title="AI ìë™ ìƒì„±" disabled>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              Auto
            </button>
          </div>
          <div class="prompt-content active" data-content="main">
            <div class="prompt-input-wrapper">
              <textarea id="prompt-source" placeholder="Convert í›„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ Auto ë²„íŠ¼ìœ¼ë¡œ ìë™ ìƒì„±í•˜ì„¸ìš”." disabled></textarea>
              <div class="prompt-btn-group">
                <button class="prompt-attach-btn" id="btn-attach-source" title="ì´ë¯¸ì§€ ì²¨ë¶€" disabled>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </button>
                <button class="prompt-generate-btn" id="btn-generate-source" title="ì´ë¯¸ì§€ ìƒì„±" disabled>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div class="prompt-content" data-content="negative">
            <div class="prompt-input-wrapper">
              <textarea id="prompt-source-negative" class="negative" placeholder="ìƒì„± ê¸ˆì§€ í•­ëª© (ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸)" disabled></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="image-panel result-panel" id="result-panel-1" data-result-index="1">
        <div class="panel-label">
          <span>Result 1</span>
          <button class="panel-guide-btn" id="btn-guide-result" title="ê°€ì´ë“œ í‘œì‹œ">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="2" x2="12" y2="22"></line>
              <line x1="2" y1="12" x2="22" y2="12"></line>
            </svg>
          </button>
          <button class="panel-expand-btn" id="btn-expand-result" title="Expand">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 3 21 3 21 9"></polyline>
              <polyline points="9 21 3 21 3 15"></polyline>
              <line x1="21" y1="3" x2="14" y2="10"></line>
              <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
          </button>
        </div>
        <div class="panel-content">
          <div class="empty-state" id="render-empty">Ready</div>
          <!-- ì´ë¯¸ì§€+ê·¸ë¦¬ë“œ ì¤Œ ì»¨í…Œì´ë„ˆ -->
          <div class="image-zoom-container" id="zoom-container-result">
            <div class="image-zoom-wrapper" id="zoom-wrapper-result">
              <img id="render-image" style="display:none;">
              <canvas class="guide-grid-canvas" id="guide-canvas-result" style="display:none;"></canvas>
            </div>
          </div>
          <!-- ê·¸ë¦¬ë“œ ì»¨íŠ¸ë¡¤ -->
          <div class="guide-controls hidden" id="guide-controls-result">
            <label>Grid</label>
            <input type="range" class="guide-slider" id="guide-slider-result" min="10" max="100" value="40">
            <span class="guide-value" id="guide-value-result">40px</span>
            <button class="guide-lock-btn" id="guide-lock-result" title="Lock">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
            </button>
            <label style="margin-left:8px;">Zoom</label>
            <input type="range" class="guide-zoom-slider" id="guide-zoom-result" min="50" max="150" value="100">
          </div>
          <div class="loading-overlay hidden" id="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Generating...</div>
            <div class="loading-subtext">AI rendering in progress</div>
            <div class="loading-progress"><div class="loading-progress-bar"></div></div>
          </div>
        </div>
        <div class="prompt-area" id="prompt-area-result">
          <div class="prompt-header">
            <div class="prompt-tabs">
              <button class="prompt-tab active" data-tab="main">Prompt</button>
              <button class="prompt-tab negative" data-tab="negative">Negative</button>
            </div>
            <button class="prompt-auto-btn" id="btn-auto-prompt-result" title="AI ìë™ ìƒì„±" disabled>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              Auto
            </button>
          </div>
          <div class="prompt-content active" data-content="main">
            <div class="prompt-input-wrapper">
              <textarea id="prompt-result" placeholder="ë Œë”ë§ ì™„ë£Œ í›„ 2ì°¨ ìƒì„±ìš© í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." disabled></textarea>
              <div class="prompt-btn-group">
                <button class="prompt-attach-btn" id="btn-attach-result" title="ì´ë¯¸ì§€ ì²¨ë¶€" disabled>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </button>
                <button class="prompt-generate-btn" id="btn-regenerate-1" title="2ì°¨ ìƒì„±" disabled>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div class="prompt-content" data-content="negative">
            <div class="prompt-input-wrapper">
              <textarea id="prompt-result-negative" class="negative" placeholder="2ì°¨ ìƒì„± ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸" disabled></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <span id="status-text">Ready</span>
    </div>

  </main>

  <!-- ========================================
       Node Editor Mode - VizMaker Style
       ======================================== -->
  <div class="node-editor-container" id="node-editor-container">
    <!-- ìº”ë²„ìŠ¤ Wrapper (ìº”ë²„ìŠ¤ + Inspector) -->
    <div class="node-canvas-wrapper">
      <!-- í™•ëŒ€ í”„ë¦¬ë·° ì˜¤ë²„ë ˆì´ (Enlarge ëª¨ë“œ) -->
      <div class="node-enlarged-preview" id="node-enlarged-preview">
        <div class="node-enlarged-topbar">
          <div class="node-enlarged-tabs">
            <button class="node-enlarged-tab active" data-tab="preview">Preview</button>
            <button class="node-enlarged-tab" data-tab="compare">Compare</button>
            <button class="node-enlarged-tab" data-tab="draw">Draw</button>
          </div>
          <div class="node-enlarged-info">
            <span class="node-enlarged-zoom" id="node-enlarged-zoom">100%</span>
          </div>
        </div>
        <div class="node-enlarged-image" id="node-enlarged-image">
          <span class="node-inspector-preview-empty">No preview</span>
        </div>
      </div>

      <!-- ë…¸ë“œ ìº”ë²„ìŠ¤ -->
      <div class="node-canvas-area" id="node-canvas-area">
        <div class="node-canvas-grid"></div>
        <svg class="node-connections" id="node-connections"></svg>
        <div class="node-canvas" id="node-canvas">
          <!-- ë…¸ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>

        <!-- ìƒë‹¨ ë²„íŠ¼ -->
        <div class="node-canvas-topbar">
          <button class="node-canvas-btn" id="node-add-source" title="Add Source">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <line x1="12" y1="8" x2="12" y2="16"/>
              <line x1="8" y1="12" x2="16" y2="12"/>
            </svg>
            Source
          </button>
          <button class="node-canvas-btn" id="node-add-renderer" title="Add Renderer">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width:12px;height:12px;">
              <path d="M.968 9.027l7.717 4.428-.006 1.32-4.39-2.518-2.763 1.57 7.148 4.12.005 1.27-7.658-4.405c.02.516.488 2.106 1.383 3.337.91 1.247 1.946 1.776 1.946 1.776L11.428 24V11.849L.975 5.846zm22.064-3.8L15.22.723S13.982 0 12.008 0C9.952 0 8.76.746 8.76.746l-7.236 4.14 11.009 6.328V24l7.245-4.136s1.295-.715 2.279-2.414c.867-1.496.975-2.943.975-2.943z"/>
            </svg>
            Renderer
          </button>
          <button class="node-canvas-btn" id="node-delete" title="Delete Selected">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
          <button class="node-canvas-btn" id="node-fit" title="Fit View">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- ë…¸ë“œ Inspector íŒ¨ë„ - VizMaker Style -->
      <aside class="node-inspector" id="node-inspector">
        <!-- Preview ì˜ì—­ -->
        <div class="node-inspector-preview">
          <!-- Enlarge ë²„íŠ¼ -->
          <button class="node-enlarge-btn" id="node-enlarge-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
              <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
            </svg>
            Enlarge
          </button>
          <!-- íƒ­ -->
          <div class="node-inspector-tabs">
            <button class="node-inspector-tab active" data-tab="preview">Preview</button>
            <button class="node-inspector-tab" data-tab="compare">Compare</button>
            <button class="node-inspector-tab" data-tab="draw">Draw</button>
          </div>
          <!-- Preview íƒ­ ì»¨í…ì¸  -->
          <div class="node-preview-tab-content active" data-content="preview">
            <div class="node-inspector-preview-image" id="node-preview-image">
              <span class="node-inspector-preview-empty">No preview</span>
            </div>
          </div>
          <!-- Compare íƒ­ ì»¨í…ì¸  -->
          <div class="node-preview-tab-content" data-content="compare">
            <div class="node-inspector-preview-image node-compare-view" id="node-compare-view">
              <span class="node-inspector-preview-empty">No images to compare</span>
            </div>
          </div>
          <!-- Draw íƒ­ ì»¨í…ì¸  -->
          <div class="node-preview-tab-content" data-content="draw">
            <div class="node-inspector-preview-image node-draw-view" id="node-draw-view">
              <span class="node-inspector-preview-empty">Draw mode (coming soon)</span>
            </div>
          </div>
          <div class="node-inspector-preview-progress">
            <div class="node-inspector-preview-progress-bar" id="node-preview-progress"></div>
          </div>
        </div>

        <!-- ë…¸ë“œ ë¯¸ì„ íƒ ì‹œ -->
        <div class="node-inspector-empty" id="node-inspector-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M18 3C19.6569 3 21 4.34315 21 6C21 7.65685 19.6569 9 18 9H15C13.6941 9 12.5831 8.16562 12.171 7.0009L11 7C9.9 7 9 7.9 9 9L9.0009 9.17102C10.1656 9.58312 11 10.6941 11 12C11 13.3059 10.1656 14.4169 9.0009 14.829L9 15C9 16.1 9.9 17 11 17L12.1707 17.0001C12.5825 15.8349 13.6937 15 15 15H18C19.6569 15 21 16.3431 21 18C21 19.6569 19.6569 21 18 21H15C13.6941 21 12.5831 20.1656 12.171 19.0009L11 19C8.79 19 7 17.21 7 15H5C3.34315 15 2 13.6569 2 12C2 10.3431 3.34315 9 5 9H7C7 6.79086 8.79086 5 11 5L12.1707 5.00009C12.5825 3.83485 13.6937 3 15 3H18Z"/>
          </svg>
          <div>Select a node to edit</div>
          <div style="font-size: 11px; margin-top: 8px;">Click on a node or add a new one</div>
        </div>

        <!-- Inspector ì»¨í…ì¸  (ìŠ¤í¬ë¡¤ ì˜ì—­) -->
        <div class="node-inspector-content" id="node-inspector-content">
          <!-- Source ë…¸ë“œ Inspector -->
          <div class="hidden" id="inspector-source">
            <!-- Camera ì•„ì½”ë””ì–¸ -->
            <div class="node-inspector-accordion open">
              <div class="node-inspector-accordion-header">
                <div class="node-inspector-accordion-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                    <circle cx="12" cy="13" r="4"/>
                  </svg>
                </div>
                <span class="node-inspector-accordion-title">Camera</span>
                <div class="node-inspector-accordion-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
              </div>
              <div class="node-inspector-accordion-body">
                <div class="control-section">
                  <span class="section-label">View</span>
                  <div class="dropdown-selected" id="node-source-view">Current View</div>
                </div>
              </div>
            </div>

            <!-- Time & Lighting ì•„ì½”ë””ì–¸ -->
            <div class="node-inspector-accordion open">
              <div class="node-inspector-accordion-header">
                <div class="node-inspector-accordion-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                  </svg>
                </div>
                <span class="node-inspector-accordion-title">Time & Lighting</span>
                <div class="node-inspector-accordion-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
              </div>
              <div class="node-inspector-accordion-body">
                <div class="control-section">
                  <span class="section-label">Time</span>
                  <div class="segmented">
                    <button class="seg-btn active" data-time="day">Day</button>
                    <button class="seg-btn" data-time="sunset">Sunset</button>
                    <button class="seg-btn" data-time="night">Night</button>
                  </div>
                </div>
                <div class="control-section">
                  <span class="section-label">Lights</span>
                  <div class="segmented">
                    <button class="seg-btn active" data-light="on">On</button>
                    <button class="seg-btn" data-light="off">Off</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Capture ë²„íŠ¼ -->
            <div style="padding: 16px;">
              <button class="btn btn-primary" id="node-source-capture" style="width: 100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;margin-right:6px;">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                  <circle cx="12" cy="13" r="4"/>
                </svg>
                Capture View
              </button>
            </div>
          </div>

          <!-- Renderer ë…¸ë“œ Inspector -->
          <div class="hidden" id="inspector-renderer">
            <!-- Render Settings ì•„ì½”ë””ì–¸ -->
            <div class="node-inspector-accordion open">
              <div class="node-inspector-accordion-header">
                <div class="node-inspector-accordion-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                  </svg>
                </div>
                <span class="node-inspector-accordion-title">Render Settings</span>
                <div class="node-inspector-accordion-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
              </div>
              <div class="node-inspector-accordion-body">
                <div class="control-section">
                  <span class="section-label">Render Mode</span>
                  <div class="dropdown-selected" id="node-render-mode">Nanobanana Pro</div>
                </div>
                <div class="control-section">
                  <span class="section-label">Resolution</span>
                  <div class="segmented">
                    <button class="seg-btn" data-res="1024">1K</button>
                    <button class="seg-btn active" data-res="2048">2K</button>
                    <button class="seg-btn" data-res="4096">4K</button>
                  </div>
                </div>
                <div class="control-section">
                  <span class="section-label">Aspect Ratio</span>
                  <div class="segmented">
                    <button class="seg-btn active" data-aspect="original">Original</button>
                    <button class="seg-btn" data-aspect="16:9">16:9</button>
                    <button class="seg-btn" data-aspect="1:1">1:1</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Prompt Presets ì•„ì½”ë””ì–¸ -->
            <div class="node-inspector-accordion open">
              <div class="node-inspector-accordion-header">
                <div class="node-inspector-accordion-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="21" x2="4" y2="14"/>
                    <line x1="4" y1="10" x2="4" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12" y2="3"/>
                    <line x1="20" y1="21" x2="20" y2="16"/>
                    <line x1="20" y1="12" x2="20" y2="3"/>
                  </svg>
                </div>
                <span class="node-inspector-accordion-title">Prompt Presets</span>
                <div class="node-inspector-accordion-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
              </div>
              <div class="node-inspector-accordion-body">
                <div class="prompt-presets-grid">
                  <button class="prompt-preset-btn" data-preset="realism">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    </svg>
                    <span>Realism</span>
                  </button>
                  <button class="prompt-preset-btn" data-preset="closeup">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <circle cx="11" cy="11" r="8"/>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                      <line x1="11" y1="8" x2="11" y2="14"/>
                      <line x1="8" y1="11" x2="14" y2="11"/>
                    </svg>
                    <span>Closeup</span>
                  </button>
                  <button class="prompt-preset-btn" data-preset="day-night">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                    <span>Dayâ†’Night</span>
                  </button>
                  <button class="prompt-preset-btn" data-preset="night-day">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <circle cx="12" cy="12" r="5"/>
                      <line x1="12" y1="1" x2="12" y2="3"/>
                      <line x1="12" y1="21" x2="12" y2="23"/>
                    </svg>
                    <span>Nightâ†’Day</span>
                  </button>
                  <button class="prompt-preset-btn" data-preset="brighter">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <circle cx="12" cy="12" r="5"/>
                      <line x1="12" y1="1" x2="12" y2="3"/>
                      <line x1="21" y1="12" x2="23" y2="12"/>
                    </svg>
                    <span>Brighter</span>
                  </button>
                  <button class="prompt-preset-btn" data-preset="volumetric">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>
                    </svg>
                    <span>Volumetric</span>
                  </button>
                  <button class="prompt-preset-btn" data-preset="fog">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <line x1="3" y1="8" x2="21" y2="8"/>
                      <line x1="3" y1="12" x2="21" y2="12"/>
                      <line x1="3" y1="16" x2="21" y2="16"/>
                    </svg>
                    <span>Fog</span>
                  </button>
                  <button class="prompt-preset-btn" data-preset="people">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                      <circle cx="9" cy="7" r="4"/>
                    </svg>
                    <span>People</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Custom Prompt ì•„ì½”ë””ì–¸ -->
            <div class="node-inspector-accordion">
              <div class="node-inspector-accordion-header">
                <div class="node-inspector-accordion-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="17" y1="10" x2="3" y2="10"/>
                    <line x1="21" y1="6" x2="3" y2="6"/>
                    <line x1="21" y1="14" x2="3" y2="14"/>
                    <line x1="17" y1="18" x2="3" y2="18"/>
                  </svg>
                </div>
                <span class="node-inspector-accordion-title">Custom Prompt</span>
                <div class="node-inspector-accordion-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
              </div>
              <div class="node-inspector-accordion-body">
                <textarea class="prompt-input" id="node-custom-prompt" placeholder="Enter custom prompt..." style="width:100%;min-height:80px;background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:10px;color:#e6edf3;font-size:11px;resize:vertical;"></textarea>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div><!-- .node-canvas-wrapper -->

    <!-- í•˜ë‹¨ í”„ë¡¬í”„íŠ¸ ë°” -->
    <div class="node-bottom-bar">
      <div class="node-bottom-prompt-area">
        <div class="node-prompt-row">
          <textarea class="node-prompt-input" id="node-prompt-input" rows="2" placeholder="Select a Renderer node to enter prompt..."></textarea>
          <button class="node-prompt-auto-btn" id="node-prompt-auto-btn" title="Auto Generate">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
            </svg>
            Auto
          </button>
        </div>
        <div class="node-prompt-row node-prompt-negative-row">
          <textarea class="node-prompt-input node-prompt-negative" id="node-prompt-negative-input" rows="1" placeholder="Negative prompt (optional)"></textarea>
        </div>
      </div>
      <button class="node-make-btn" id="node-make-btn">
        <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;">
          <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        Make
      </button>
    </div>
  </div>

  <script>
    const state = {
      originalImage: null,
      renderImage: null,
      isRendering: false,
      apiConnected: false,
      converted: false,  // Convert ì™„ë£Œ ì—¬ë¶€
      timePreset: 'day',
      lightSwitch: 'on',
      imageSize: '1024',  // â˜… ì†ë„ ìš°ì„  (1024px)
      engine: 'replicate',  // â˜… Replicate ê¸°ë³¸ (êµ¬ë„ ìœ ì§€)
      resultPanels: [{ id: 1, image: null }],  // ê²°ê³¼ íŒ¨ë„ ëª©ë¡
      nextResultId: 2,
      currentScene: null,  // í˜„ì¬ í™œì„± ì”¬ ì´ë¦„
      history: [],  // íˆìŠ¤í† ë¦¬ ë°°ì—´
      nextHistoryId: 1
    };

    // ì”¬ë³„ ìƒíƒœ ì €ì¥ì†Œ
    const sceneStates = new Map();

    // í˜„ì¬ ì”¬ ìƒíƒœ ì €ì¥
    function saveCurrentSceneState() {
      if (!state.currentScene) return;

      const promptSource = document.getElementById('prompt-source');
      const promptSourceNegative = document.getElementById('prompt-source-negative');
      const promptResult = document.getElementById('prompt-result');
      const promptResultNegative = document.getElementById('prompt-result-negative');

      sceneStates.set(state.currentScene, {
        originalImage: state.originalImage,
        renderImage: state.renderImage,
        converted: state.converted,
        promptSource: promptSource?.value || '',
        promptSourceNegative: promptSourceNegative?.value || '',
        promptResult: promptResult?.value || '',
        promptResultNegative: promptResultNegative?.value || '',
        resultPanels: JSON.parse(JSON.stringify(state.resultPanels)),
        nextResultId: state.nextResultId
      });

      console.log('[NanoBanana] ì”¬ ìƒíƒœ ì €ì¥:', state.currentScene, 'Result ì´ë¯¸ì§€:', state.resultPanels[0]?.image ? 'ìˆìŒ' : 'ì—†ìŒ');
    }

    // ì”¬ ìƒíƒœ ë³µì› (el ê°ì²´ ì´ˆê¸°í™” í›„ í˜¸ì¶œë¨)
    function restoreSceneState(sceneName) {
      const savedState = sceneStates.get(sceneName);

      const originalImage = document.getElementById('original-image');
      const originalEmpty = document.getElementById('original-empty');
      const renderImage = document.getElementById('render-image');
      const renderEmpty = document.getElementById('render-empty');
      const btnRender = document.getElementById('btn-generate-source');
      const btnEdit = document.getElementById('btn-edit');
      const btnSave = document.getElementById('btn-save');
      const promptSource = document.getElementById('prompt-source');
      const promptSourceNegative = document.getElementById('prompt-source-negative');
      const promptResult = document.getElementById('prompt-result');
      const promptResultNegative = document.getElementById('prompt-result-negative');

      if (savedState) {
        // ì €ì¥ëœ ìƒíƒœ ë³µì›
        state.originalImage = savedState.originalImage;
        state.renderImage = savedState.renderImage;
        state.converted = savedState.converted;
        state.resultPanels = savedState.resultPanels;
        state.nextResultId = savedState.nextResultId;

        // UI ë³µì› - SOURCE ì´ë¯¸ì§€
        if (savedState.originalImage && originalImage) {
          originalImage.src = 'data:image/png;base64,' + savedState.originalImage;
          originalImage.style.display = 'block';
          if (originalEmpty) originalEmpty.style.display = 'none';
        } else {
          if (originalImage) originalImage.style.display = 'none';
          if (originalEmpty) originalEmpty.style.display = 'flex';
        }

        // UI ë³µì› - RESULT ì´ë¯¸ì§€ (ì²«ë²ˆì§¸ resultPanel ì‚¬ìš©)
        const firstResult = savedState.resultPanels && savedState.resultPanels[0];
        if (firstResult && firstResult.image && renderImage) {
          renderImage.src = 'data:image/png;base64,' + firstResult.image;
          renderImage.style.display = 'block';
          if (renderEmpty) renderEmpty.style.display = 'none';
          if (btnEdit) btnEdit.disabled = false;
          if (btnSave) btnSave.disabled = false;
        } else if (savedState.renderImage && renderImage) {
          renderImage.src = 'data:image/png;base64,' + savedState.renderImage;
          renderImage.style.display = 'block';
          if (renderEmpty) renderEmpty.style.display = 'none';
          if (btnEdit) btnEdit.disabled = false;
          if (btnSave) btnSave.disabled = false;
        } else {
          if (renderImage) renderImage.style.display = 'none';
          if (renderEmpty) renderEmpty.style.display = 'flex';
          if (btnEdit) btnEdit.disabled = true;
          if (btnSave) btnSave.disabled = true;
        }

        // UI ë³µì› - í”„ë¡¬í”„íŠ¸
        if (promptSource) promptSource.value = savedState.promptSource || '';
        if (promptSourceNegative) promptSourceNegative.value = savedState.promptSourceNegative || '';
        if (promptResult) promptResult.value = savedState.promptResult || '';
        if (promptResultNegative) promptResultNegative.value = savedState.promptResultNegative || '';

        // Render ë²„íŠ¼ ìƒíƒœ
        if (btnRender) btnRender.disabled = !savedState.originalImage || !savedState.promptSource;

        console.log('[NanoBanana] ì”¬ ìƒíƒœ ë³µì›:', sceneName, 'Result ì´ë¯¸ì§€:', firstResult?.image ? 'ìˆìŒ' : 'ì—†ìŒ');
      } else {
        // ìƒˆ ì”¬ - ì´ˆê¸° ìƒíƒœë¡œ
        state.originalImage = null;
        state.renderImage = null;
        state.converted = false;
        state.resultPanels = [{ id: 1, image: null }];
        state.nextResultId = 2;

        if (originalImage) originalImage.style.display = 'none';
        if (originalEmpty) originalEmpty.style.display = 'flex';
        if (renderImage) renderImage.style.display = 'none';
        if (renderEmpty) renderEmpty.style.display = 'flex';

        if (promptSource) promptSource.value = '';
        if (promptSourceNegative) promptSourceNegative.value = '';
        if (promptResult) promptResult.value = '';
        if (promptResultNegative) promptResultNegative.value = '';

        if (btnRender) btnRender.disabled = true;
        if (btnEdit) btnEdit.disabled = true;
        if (btnSave) btnSave.disabled = true;

        console.log('[NanoBanana] ìƒˆ ì”¬ ì´ˆê¸°í™”:', sceneName);
      }

      state.currentScene = sceneName;
    }

    // ì”¬ ì „í™˜ ì²˜ë¦¬ (Rubyì—ì„œ í˜¸ì¶œ)
    window.onSceneChanged = function(sceneName) {
      // í˜„ì¬ ì”¬ ìƒíƒœ ì €ì¥
      saveCurrentSceneState();
      // ìƒˆ ì”¬ ìƒíƒœ ë³µì›
      restoreSceneState(sceneName);
      console.log('[NanoBanana] Scene changed to:', sceneName);
    };

    const el = {
      originalImage: document.getElementById('original-image'),
      originalEmpty: document.getElementById('original-empty'),
      renderImage: document.getElementById('render-image'),
      renderEmpty: document.getElementById('render-empty'),
      loading: document.getElementById('loading'),
      loadingSource: document.getElementById('loading-source'),
      btnCapture: document.getElementById('btn-capture'),
      btnRender: document.getElementById('btn-generate-source'),
      btnEdit: document.getElementById('btn-edit'),
      btnSave: document.getElementById('btn-save'),
      btnSettings: document.getElementById('btn-settings'),
      btnAutoPrompt: document.getElementById('btn-auto-prompt'),
      btnAttachSource: document.getElementById('btn-attach-source'),
      btnGenerateSource: document.getElementById('btn-generate-source'),
      statusText: document.getElementById('status-text'),
      statusDot: document.getElementById('status-dot'),
      apiStatus: document.getElementById('api-status'),
      promptSource: document.getElementById('prompt-source'),
      promptSourceNegative: document.getElementById('prompt-source-negative'),
      promptResult: document.getElementById('prompt-result'),
      promptResultNegative: document.getElementById('prompt-result-negative'),
      btnAutoPromptResult: document.getElementById('btn-auto-prompt-result'),
      btnRegenerateResult: document.getElementById('btn-regenerate-1')
    };

    // í”„ë¡¬í”„íŠ¸ íƒ­ ì „í™˜
    document.querySelectorAll('.prompt-area').forEach(area => {
      area.querySelectorAll('.prompt-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          // íƒ­ í™œì„±í™”
          area.querySelectorAll('.prompt-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          // ì»¨í…ì¸  í™œì„±í™”
          area.querySelectorAll('.prompt-content').forEach(c => c.classList.remove('active'));
          area.querySelector(`.prompt-content[data-content="${tabName}"]`).classList.add('active');
        });
      });
    });

    // SketchUp Ruby ì½œë°± í˜¸ì¶œ
    function callRuby(action, ...args) {
      // skp: í”„ë¡œí† ì½œë§Œ ì‚¬ìš© (ê°€ì¥ ì•ˆì •ì )
      const param = args.length > 0 ? JSON.stringify(args) : '';
      window.location = 'skp:' + action + '@' + encodeURIComponent(param);
    }

    const sketchup = {
      captureScene: (size) => callRuby('capture_scene', size),
      startRender: (time, light, prompt, negativePrompt, renderId) => callRuby('start_render', time, light, prompt, negativePrompt, renderId || ''),
      generateAutoPrompt: (style, time, light) => callRuby('generate_auto_prompt', style || '', time || 'day', light || 'on'),
      saveImage: () => callRuby('save_image', ''),
      openEditor: () => callRuby('open_editor'),
      checkApiStatus: () => callRuby('check_api_status'),
      // Gemini API Key
      saveApiKey: (key) => callRuby('save_api_key', key),
      loadApiKey: () => callRuby('load_api_key'),
      testConnection: () => callRuby('test_connection'),
      // Replicate API
      saveReplicateToken: (token) => callRuby('save_replicate_token', token),
      loadReplicateToken: () => callRuby('load_replicate_token'),
      // Engine selection
      setEngine: (engine) => callRuby('set_engine', engine),
      getEngine: () => callRuby('get_engine'),
      // Model selection
      saveModel: (model) => callRuby('save_model', model),
      loadModel: () => callRuby('load_model'),
      // Camera controls
      camMove: (dir) => callRuby('cam_move', dir),
      camRotate: (dir) => callRuby('cam_rotate', dir),
      camHeight: (preset) => callRuby('cam_height', preset),
      camFov: (preset) => callRuby('cam_fov', preset),
      startMirror: () => callRuby('start_mirror'),
      stopMirror: () => callRuby('stop_mirror'),
      // Scene controls
      getScenes: () => callRuby('get_scenes'),
      selectScene: (name) => callRuby('select_scene', name),
      addScene: () => callRuby('add_scene'),
      // 2ì  íˆ¬ì‹œ
      apply2Point: () => callRuby('apply_2point'),
      // Mix - ì„ íƒëœ íŒ¨ë„ì˜ ì´ë¯¸ì§€ ì „ë‹¬
      openMix: (imageBase64) => callRuby('open_mix', imageBase64),
      // 2ì°¨ ìƒì„± (ì†ŒìŠ¤ ì´ë¯¸ì§€ base64, í”„ë¡¬í”„íŠ¸, ëŒ€ìƒ íŒ¨ë„ ID)
      regenerate: (sourceBase64, prompt, panelId) => callRuby('regenerate', sourceBase64, prompt, panelId),
      // íˆìŠ¤í† ë¦¬
      loadHistory: () => callRuby('load_history'),
      saveHistory: (json) => callRuby('save_history', json)
    };

    let mirrorActive = false;
    let selectedPanel = 'source'; // 'source' or 'result'

    // íŒ¨ë„ ì„ íƒ ê¸°ëŠ¥
    function selectPanel(panelType) {
      selectedPanel = panelType;

      // ëª¨ë“  íŒ¨ë„ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
      document.querySelectorAll('.image-panel').forEach(p => p.classList.remove('selected'));

      // ì„ íƒëœ íŒ¨ë„ì— selected í´ë˜ìŠ¤ ì¶”ê°€
      if (panelType === 'source') {
        document.getElementById('source-panel').classList.add('selected');
      } else {
        document.getElementById('result-panel-1').classList.add('selected');
      }
    }

    // ì„ íƒëœ íŒ¨ë„ì˜ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
    function getSelectedImage() {
      if (selectedPanel === 'source') {
        return state.originalImage;
      } else {
        return state.renderImage;
      }
    }

    function onCaptureComplete(base64, materialCount) {
      // ë…¸ë“œ ì—ë””í„° ì½œë°±ì´ ìˆìœ¼ë©´ ìš°ì„  ì²˜ë¦¬
      if (window._nodeSourceCallback) {
        window._nodeSourceCallback(base64);
        window._nodeSourceCallback = null;
        return;
      }

      state.originalImage = base64;
      el.originalImage.src = 'data:image/png;base64,' + base64;
      el.originalImage.style.display = 'block';
      el.originalEmpty.style.display = 'none';
      setStatus('Analyzing scene...');
      // Render ë²„íŠ¼ì€ onConvertCompleteì—ì„œ í™œì„±í™”
    }

    // Convert ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ (Rubyì—ì„œ í˜¸ì¶œ)
    function updateConvertProgress(stage, detail) {
      const loadingText = el.loadingSource.querySelector('.loading-text');
      const loadingSubtext = el.loadingSource.querySelector('.loading-subtext');
      if (loadingText) loadingText.textContent = stage;
      if (loadingSubtext) loadingSubtext.textContent = detail;
      setStatus(stage + ' - ' + detail);
    }

    // Convert ì—ëŸ¬ (Rubyì—ì„œ í˜¸ì¶œ)
    function onConvertError(errorMsg) {
      stopConvertProgress(false);
      el.btnCapture.disabled = false;
      el.btnCapture.textContent = 'Convert';
      el.loadingSource.classList.add('hidden');
      setStatus('Convert ì‹¤íŒ¨: ' + errorMsg);
    }

    // Convert ì™„ë£Œ (ì”¬ ë¶„ì„ ì™„ë£Œ - í”„ë¡¬í”„íŠ¸ëŠ” ë³„ë„)
    function onConvertComplete(promptText) {
      stopConvertProgress(true);
      state.converted = true;
      el.btnCapture.disabled = false;
      el.btnCapture.textContent = 'Convert';

      // 100% í‘œì‹œ í›„ ë¡œë”© ìˆ¨ê¹€
      setTimeout(() => {
        el.loadingSource.classList.add('hidden');
      }, 500);

      // í”„ë¡¬í”„íŠ¸ì°½ í™œì„±í™” (ë¹„ì›Œë‘  - ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ Auto ì‚¬ìš©)
      el.promptSource.value = '';
      el.promptSource.disabled = false;
      el.promptSource.placeholder = 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ Auto ë²„íŠ¼ìœ¼ë¡œ ìë™ ìƒì„±í•˜ì„¸ìš”.';
      el.promptSourceNegative.value = '';
      el.promptSourceNegative.disabled = false;

      // Auto ë²„íŠ¼ ë° ê¸°íƒ€ ë²„íŠ¼ í™œì„±í™”
      el.btnAutoPrompt.disabled = false;
      el.btnAttachSource.disabled = false;
      el.btnGenerateSource.disabled = false;

      // Render ë²„íŠ¼ì€ í”„ë¡¬í”„íŠ¸ ì…ë ¥ í›„ í™œì„±í™” (ë˜ëŠ” Auto í›„)
      el.btnRender.disabled = true;

      setStatus('Convert ì™„ë£Œ - í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ Auto ìƒì„±í•˜ì„¸ìš”');
    }

    // Auto í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹œì‘
    function onAutoPromptStart() {
      el.btnAutoPrompt.disabled = true;
      el.btnAutoPrompt.classList.add('loading');
      el.btnAutoPrompt.innerHTML = `
        <svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 6v6l4 2"></path>
        </svg>
        ìƒì„±ì¤‘...
      `;

      // SOURCE ì˜ì—­ì— ë¡œë”© ì˜¤ë²„ë ˆì´ + í”„ë¡œê·¸ë ˆìŠ¤ ë°” í‘œì‹œ
      el.loadingSource.innerHTML = `
        <div class="auto-prompt-loading">
          <div class="loading-spinner"></div>
          <div class="loading-status">í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...</div>
          <div class="loading-detail">ì”¬ ë¶„ì„ ë° ì¬ì§ˆ ì •ë³´ ì¶”ì¶œ</div>
          <div class="prompt-progress-container">
            <div class="prompt-progress-bar" id="prompt-progress-bar"></div>
          </div>
          <div class="prompt-progress-text" id="prompt-progress-text">0%</div>
        </div>
      `;
      el.loadingSource.classList.remove('hidden');

      // í”„ë¡œê·¸ë ˆìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
      startPromptProgress();

      setStatus('Auto í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...');
    }

    // í”„ë¡¬í”„íŠ¸ ìƒì„± í”„ë¡œê·¸ë ˆìŠ¤ ë³€ìˆ˜
    let promptProgressInterval = null;
    let promptProgressValue = 0;

    // í”„ë¡¬í”„íŠ¸ ìƒì„± í”„ë¡œê·¸ë ˆìŠ¤ ì‹œì‘
    function startPromptProgress() {
      promptProgressValue = 0;
      promptProgressInterval = setInterval(() => {
        // 90%ê¹Œì§€ë§Œ ìë™ ì¦ê°€ (ì™„ë£Œ ì‹œ 100%ë¡œ ì í”„)
        if (promptProgressValue < 90) {
          promptProgressValue += Math.random() * 8 + 2;
          if (promptProgressValue > 90) promptProgressValue = 90;
          updatePromptProgress(promptProgressValue);
        }
      }, 500);
    }

    // í”„ë¡¬í”„íŠ¸ ìƒì„± í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
    function updatePromptProgress(value) {
      const bar = document.getElementById('prompt-progress-bar');
      const text = document.getElementById('prompt-progress-text');
      if (bar) bar.style.width = value + '%';
      if (text) text.textContent = Math.round(value) + '%';
    }

    // í”„ë¡¬í”„íŠ¸ ìƒì„± í”„ë¡œê·¸ë ˆìŠ¤ ì •ì§€
    function stopPromptProgress() {
      if (promptProgressInterval) {
        clearInterval(promptProgressInterval);
        promptProgressInterval = null;
      }
      updatePromptProgress(100);
    }

    // Auto í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ
    function onAutoPromptComplete(mainPrompt, negativePrompt) {
      // ë…¸ë“œ ì—ë””í„° Auto ì½œë°±ì´ ìˆìœ¼ë©´ ìš°ì„  ì²˜ë¦¬
      if (window._nodeAutoPromptCallback) {
        window._nodeAutoPromptCallback(mainPrompt);
        // negativeë„ ë…¸ë“œì— ì €ì¥
        const negInput = document.getElementById('node-prompt-negative-input');
        if (negInput && negativePrompt) {
          negInput.value = negativePrompt;
          const node = nodeEditor.nodes.find(n => n.id === nodeEditor.selectedNode && n.type === 'renderer');
          if (node) node.data.negativePrompt = negativePrompt;
        }
        return;
      }

      // í”„ë¡œê·¸ë ˆìŠ¤ 100%ë¡œ ì™„ë£Œ
      stopPromptProgress();

      el.btnAutoPrompt.disabled = false;
      el.btnAutoPrompt.classList.remove('loading');
      el.btnAutoPrompt.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
          <path d="M2 17l10 5 10-5"></path>
          <path d="M2 12l10 5 10-5"></path>
        </svg>
        Auto
      `;

      // ì ì‹œ í›„ SOURCE ì˜ì—­ ë¡œë”© í•´ì œ (100% ë³´ì—¬ì£¼ê³ )
      setTimeout(() => {
        el.loadingSource.innerHTML = '';
        el.loadingSource.classList.add('hidden');
      }, 300);

      // í”„ë¡¬í”„íŠ¸ì°½ì— í‘œì‹œ
      el.promptSource.value = mainPrompt || '';
      el.promptSourceNegative.value = negativePrompt || '';

      // Render ë²„íŠ¼ í™œì„±í™”
      el.btnRender.disabled = false;

      setStatus('Auto í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ - Render ê°€ëŠ¥');
    }

    // Auto í”„ë¡¬í”„íŠ¸ ìƒì„± ì—ëŸ¬
    function onAutoPromptError(errorMsg) {
      // í”„ë¡œê·¸ë ˆìŠ¤ ì •ì§€
      if (promptProgressInterval) {
        clearInterval(promptProgressInterval);
        promptProgressInterval = null;
      }

      el.btnAutoPrompt.disabled = false;
      el.btnAutoPrompt.classList.remove('loading');
      el.btnAutoPrompt.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
          <path d="M2 17l10 5 10-5"></path>
          <path d="M2 12l10 5 10-5"></path>
        </svg>
        Auto
      `;

      // SOURCE ì˜ì—­ì— ì—ëŸ¬ í‘œì‹œ
      el.loadingSource.innerHTML = `
        <div class="auto-prompt-error">
          <span style="color: #ff6b6b;">í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹¤íŒ¨</span>
          <span style="font-size: 11px; color: #888;">${errorMsg}</span>
        </div>
      `;
      el.loadingSource.classList.remove('hidden');
      // 3ì´ˆ í›„ ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¹€
      setTimeout(() => {
        el.loadingSource.innerHTML = '';
        el.loadingSource.classList.add('hidden');
      }, 3000);

      setStatus('Auto í”„ë¡¬í”„íŠ¸ ì‹¤íŒ¨: ' + errorMsg);
    }

    // ë Œë”ë§ ì¤‘ì¸ ì”¬ ëª©ë¡ ê´€ë¦¬
    const renderingScenes = new Map(); // sceneName -> { startTime }

    function onRenderStart(sceneName) {
      state.isRendering = true;
      el.loading.classList.remove('hidden');
      // Render ë²„íŠ¼ì€ í™œì„±í™” ìƒíƒœ ìœ ì§€ (ì—°ì† ë Œë”ë§ ê°€ëŠ¥)
      // el.btnRender.disabled = true;

      // í•´ë‹¹ ì”¬ íƒ­ì— ë¡œë”© í‘œì‹œ
      if (sceneName) {
        renderingScenes.set(sceneName, { startTime: Date.now() });
        updateSceneTabStatus(sceneName, 'rendering');
      }

      setStatus('Rendering: ' + (sceneName || 'Unknown'));
    }

    function onRenderComplete(base64, sceneName, panelId = 1) {

      state.renderImage = base64;

      // í•´ë‹¹ íŒ¨ë„ì˜ ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥
      const panelData = state.resultPanels.find(p => p.id === panelId);
      if (panelData) panelData.image = base64;

      el.renderImage.src = 'data:image/png;base64,' + base64;
      el.renderImage.style.display = 'block';
      el.renderEmpty.style.display = 'none';
      el.loading.classList.add('hidden');
      el.btnRender.disabled = false;
      el.btnEdit.disabled = false;
      el.btnSave.disabled = false;

      // RESULT í”„ë¡¬í”„íŠ¸ ì˜ì—­ í™œì„±í™” (2ì°¨ ìƒì„±ìš©)
      el.promptResult.disabled = false;
      el.promptResult.placeholder = '2ì°¨ ìƒì„±ìš© í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
      el.promptResultNegative.disabled = false;
      el.btnAutoPromptResult.disabled = false;
      el.btnRegenerateResult.disabled = false;

      // í•´ë‹¹ ì”¬ íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
      if (sceneName) {
        renderingScenes.delete(sceneName);
        updateSceneTabStatus(sceneName, 'complete');
        // 3ì´ˆ í›„ ìƒíƒœ ì´ˆê¸°í™”
        setTimeout(() => updateSceneTabStatus(sceneName, 'normal'), 3000);
      }

      // ë‹¤ë¥¸ ì”¬ì´ ì•„ì§ ë Œë”ë§ ì¤‘ì¸ì§€ í™•ì¸
      state.isRendering = renderingScenes.size > 0;

      // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
      addToHistory(base64, sceneName || 'Unknown');

      setStatus('Complete: ' + (sceneName || 'Unknown'));
    }

    // ===== ë…¸ë“œ ì—ë””í„° ë³‘ë ¬ ë Œë”ë§ ì½œë°± =====
    // ë…¸ë“œë³„ ì½œë°± ë§µ (render_id â†’ resolve function)
    window._nodeRendererCallbacks = {};

    function onNodeRenderComplete(renderId, base64) {
      console.log('[Node] Render complete:', renderId);
      const cb = window._nodeRendererCallbacks[renderId];
      if (cb) {
        cb({ success: true, image: base64 });
        delete window._nodeRendererCallbacks[renderId];
      }
    }

    function onNodeRenderError(renderId, errorMsg) {
      console.error('[Node] Render error:', renderId, errorMsg);
      const cb = window._nodeRendererCallbacks[renderId];
      if (cb) {
        cb({ success: false, error: errorMsg });
        delete window._nodeRendererCallbacks[renderId];
      }
    }

    // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
    function addToHistory(image, sceneName) {
      const historyItem = {
        id: state.nextHistoryId++,
        image: image,
        scene: sceneName,
        timestamp: Date.now(),
        prompt: el.promptSource?.value || '',
        negativePrompt: el.promptSourceNegative?.value || ''
      };

      state.history.unshift(historyItem);

      // ìµœëŒ€ 500ê°œ ìœ ì§€
      if (state.history.length > 500) {
        state.history = state.history.slice(0, 500);
      }

      // íŒŒì¼ì— ì €ì¥
      sketchup.save_history(JSON.stringify(state.history));

      // ê°¤ëŸ¬ë¦¬ ì—…ë°ì´íŠ¸
      renderHistoryGallery();
    }

    // íˆìŠ¤í† ë¦¬ ê°¤ëŸ¬ë¦¬ ë Œë”ë§
    function renderHistoryGallery() {
      const gallery = document.getElementById('history-gallery');
      if (!gallery) return;

      gallery.innerHTML = '';

      state.history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `<img src="data:image/png;base64,${item.image}" alt="${item.scene}">`;
        div.onclick = () => loadHistoryItem(item);
        gallery.appendChild(div);
      });
    }

    // íˆìŠ¤í† ë¦¬ ì•„ì´í…œ ë¡œë“œ
    function loadHistoryItem(item) {
      state.renderImage = item.image;
      el.renderImage.src = 'data:image/png;base64,' + item.image;
      el.renderImage.style.display = 'block';
      el.renderEmpty.style.display = 'none';

      if (item.prompt) el.promptSource.value = item.prompt;
      if (item.negativePrompt) el.promptSourceNegative.value = item.negativePrompt;
    }

    // íˆìŠ¤í† ë¦¬ ë¡œë“œ ì½œë°± (Rubyì—ì„œ í˜¸ì¶œ)
    function onHistoryLoaded(historyArray) {
      console.log('[NanoBanana] íˆìŠ¤í† ë¦¬ ë¡œë“œ:', historyArray.length, 'ê°œ');
      state.history = historyArray || [];
      state.nextHistoryId = state.history.length > 0 ? Math.max(...state.history.map(h => h.id || 0)) + 1 : 1;
      renderHistoryGallery();
    }

    function onRenderError(msg, sceneName) {
      el.loading.classList.add('hidden');
      el.btnRender.disabled = false;

      // í•´ë‹¹ ì”¬ íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
      if (sceneName) {
        renderingScenes.delete(sceneName);
        updateSceneTabStatus(sceneName, 'error');
        // 5ì´ˆ í›„ ìƒíƒœ ì´ˆê¸°í™”
        setTimeout(() => updateSceneTabStatus(sceneName, 'normal'), 5000);
      }

      // ë‹¤ë¥¸ ì”¬ì´ ì•„ì§ ë Œë”ë§ ì¤‘ì¸ì§€ í™•ì¸
      state.isRendering = renderingScenes.size > 0;

      setStatus('Error: ' + msg);
    }

    // ì”¬ íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateSceneTabStatus(sceneName, status) {
      const tabs = document.querySelectorAll('.scene-tab');
      tabs.forEach(tab => {
        if (tab.dataset.scene === sceneName) {
          // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
          tab.classList.remove('rendering', 'render-complete', 'render-error');

          // ìŠ¤í”¼ë„ˆ ì œê±°/ì¶”ê°€
          const existingSpinner = tab.querySelector('.scene-tab-spinner');
          if (existingSpinner) existingSpinner.remove();

          if (status === 'rendering') {
            tab.classList.add('rendering');
            // ìŠ¤í”¼ë„ˆ ì¶”ê°€
            const spinner = document.createElement('div');
            spinner.className = 'scene-tab-spinner';
            tab.insertBefore(spinner, tab.firstChild);
          } else if (status === 'complete') {
            tab.classList.add('render-complete');
          } else if (status === 'error') {
            tab.classList.add('render-error');
          }
        }
      });
    }

    function onApiStatusUpdate(connected) {
      state.apiConnected = connected;
      el.statusDot.classList.toggle('connected', connected);
      el.apiStatus.textContent = connected ? 'Connected' : 'Disconnected';
    }

    // ë Œë”ë§ íƒ€ì´ë¨¸
    let renderStartTime = null;
    let renderTimerInterval = null;
    const loadingText = document.getElementById('loading-text');

    function startRenderTimer() {
      renderStartTime = Date.now();
      if (renderTimerInterval) clearInterval(renderTimerInterval);
      renderTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - renderStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        const timeStr = mins > 0 ? `${mins}ë¶„ ${secs}ì´ˆ` : `${secs}ì´ˆ`;
        el.statusText.textContent = `AI ì´ë¯¸ì§€ ìƒì„±ì¤‘... ${timeStr}`;
        if (loadingText) loadingText.textContent = `AI ì´ë¯¸ì§€ ìƒì„±ì¤‘... ${timeStr}`;
      }, 1000);
    }

    function stopRenderTimer(finalStatus) {
      if (renderTimerInterval) {
        clearInterval(renderTimerInterval);
        renderTimerInterval = null;
      }
      if (renderStartTime) {
        const elapsed = Math.floor((Date.now() - renderStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        const timeStr = mins > 0 ? `${mins}ë¶„ ${secs}ì´ˆ` : `${secs}ì´ˆ`;
        el.statusText.textContent = finalStatus ? `${finalStatus} (${timeStr})` : `ì™„ë£Œ (${timeStr})`;
        renderStartTime = null;
      } else {
        el.statusText.textContent = finalStatus || 'Ready';
      }
    }

    function setStatus(text) {
      // ë Œë”ë§ ì™„ë£Œ/ì—ëŸ¬ ì‹œ íƒ€ì´ë¨¸ ë©ˆì¶”ê³  ìƒíƒœ í‘œì‹œ
      const lowerText = text.toLowerCase();
      if (lowerText.includes('complete') || lowerText.includes('done') || lowerText.includes('error') || lowerText.includes('failed')) {
        stopRenderTimer(text);
      } else if (!renderTimerInterval) {
        el.statusText.textContent = text;
      }
    }

    // Convert ì§„í–‰ë¥  ê´€ë¦¬
    let convertProgressInterval = null;
    const convertSteps = [
      { percent: 5, text: 'Preparing', subtext: 'Initializing...' },
      { percent: 15, text: 'Converting', subtext: 'Capturing scene' },
      { percent: 30, text: 'Converting', subtext: 'Processing image' },
      { percent: 50, text: 'Converting', subtext: 'Analyzing scene' },
      { percent: 70, text: 'Converting', subtext: 'Generating prompt' },
      { percent: 85, text: 'Converting', subtext: 'Finalizing' },
      { percent: 95, text: 'Converting', subtext: 'Almost done' }
    ];
    let convertStepIndex = 0;

    function updateConvertProgress(percent, text, subtext) {
      const percentEl = document.getElementById('loading-percent-source');
      const subtextEl = document.getElementById('loading-subtext-source');
      const barEl = document.getElementById('loading-bar-source');

      if (percentEl) percentEl.textContent = percent + '%';
      if (subtextEl) subtextEl.textContent = subtext;
      if (barEl) {
        barEl.classList.remove('indeterminate');
        barEl.style.width = percent + '%';
      }
    }

    function startConvertProgress() {
      convertStepIndex = 0;
      updateConvertProgress(0, 'Converting', 'Preparing');

      convertProgressInterval = setInterval(() => {
        if (convertStepIndex < convertSteps.length) {
          const step = convertSteps[convertStepIndex];
          updateConvertProgress(step.percent, step.text, step.subtext);
          convertStepIndex++;
        }
      }, 800);
    }

    function stopConvertProgress(success = true) {
      if (convertProgressInterval) {
        clearInterval(convertProgressInterval);
        convertProgressInterval = null;
      }
      if (success) {
        updateConvertProgress(100, 'Complete', 'Done!');
      }
    }

    el.btnCapture.addEventListener('click', () => {
      setStatus('Converting...');
      el.btnCapture.disabled = true;
      el.btnCapture.textContent = 'Converting...';
      el.loadingSource.classList.remove('hidden');
      startConvertProgress();
      sketchup.captureScene(state.imageSize);
    });

    el.btnRender.addEventListener('click', () => {
      startRenderTimer();
      const prompt = el.promptSource.value || '';
      const negativePrompt = el.promptSourceNegative.value || '';
      sketchup.startRender(state.timePreset, state.lightSwitch, prompt, negativePrompt);
    });

    // Auto í”„ë¡¬í”„íŠ¸ ë²„íŠ¼ - ë°”ë¡œ ìƒì„± (í˜„ì¬ ë¼ì´íŒ… ì„¤ì • ì „ë‹¬)
    el.btnAutoPrompt.addEventListener('click', () => {
      sketchup.generateAutoPrompt('', state.timePreset, state.lightSwitch);
    });

    // í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì‹œ Render ë²„íŠ¼ í™œì„±í™”
    el.promptSource.addEventListener('input', () => {
      if (state.converted && el.promptSource.value.trim()) {
        el.btnRender.disabled = false;
      } else if (state.converted) {
        el.btnRender.disabled = true;
      }
    });

    el.btnSave.addEventListener('click', () => sketchup.saveImage());
    el.btnEdit.addEventListener('click', () => sketchup.openEditor());
    el.btnSettings.addEventListener('click', () => openSettingsPanel());

    // ì„¤ì • í™”ë©´ ì—´ê¸°/ë‹«ê¸°
    function openSettingsPanel() {
      document.getElementById('render-main-area').style.display = 'none';
      document.getElementById('settings-main-area').style.display = 'flex';
      sketchup.loadApiKey();
    }

    function closeSettingsPanel() {
      document.getElementById('settings-main-area').style.display = 'none';
      document.getElementById('render-main-area').style.display = 'flex';
    }

    // ì„¤ì • í™”ë©´ ì´ë²¤íŠ¸
    document.getElementById('btn-close-settings').addEventListener('click', closeSettingsPanel);

    document.getElementById('btn-toggle-api-key').addEventListener('click', function() {
      const input = document.getElementById('settings-api-key');
      if (input.type === 'password') {
        input.type = 'text';
        this.textContent = 'ğŸ™ˆ';
      } else {
        input.type = 'password';
        this.textContent = 'ğŸ‘ï¸';
      }
    });

    document.getElementById('btn-test-api').addEventListener('click', function() {
      const input = document.getElementById('settings-api-key');
      const apiKey = input.value.trim();
      const hasStoredKey = input.placeholder && input.placeholder.includes('ì €ì¥ë¨');

      // ìƒˆë¡œ ì…ë ¥í•œ í‚¤ê°€ ì—†ê³ , ì €ì¥ëœ í‚¤ë„ ì—†ìœ¼ë©´ ì—ëŸ¬
      if (!apiKey && !hasStoredKey) {
        document.getElementById('settings-status-dot').className = 'settings-status-dot error';
        document.getElementById('settings-status-text').textContent = 'API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”';
        return;
      }

      document.getElementById('settings-status-dot').className = 'settings-status-dot testing';
      document.getElementById('settings-status-text').textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘...';

      // ìƒˆ í‚¤ ì…ë ¥í–ˆìœ¼ë©´ ì €ì¥ í›„ í…ŒìŠ¤íŠ¸, ì•„ë‹ˆë©´ ë°”ë¡œ í…ŒìŠ¤íŠ¸
      if (apiKey) {
        sketchup.saveApiKey(apiKey);
        setTimeout(() => sketchup.testConnection(), 500);
      } else {
        sketchup.testConnection();
      }
    });

    document.getElementById('btn-save-settings').addEventListener('click', function() {
      const apiKey = document.getElementById('settings-api-key').value.trim();
      if (apiKey) {
        sketchup.saveApiKey(apiKey);
      }
      closeSettingsPanel();
    });

    // Ruby ì½œë°±: API Key ë¡œë“œ ì™„ë£Œ
    window.onApiKeyLoaded = function(maskedKey) {
      const input = document.getElementById('settings-api-key');
      const statusDot = document.getElementById('settings-status-dot');
      const statusText = document.getElementById('settings-status-text');

      if (maskedKey && maskedKey.length > 0) {
        input.placeholder = maskedKey + ' (ì €ì¥ë¨)';
        input.value = '';
        // API í‚¤ê°€ ìˆìœ¼ë©´ ì—°ê²° ìƒíƒœë„ í‘œì‹œ
        statusDot.className = 'settings-status-dot success';
        statusText.textContent = 'ì—°ê²°ë¨ (ì €ì¥ëœ í‚¤ ì‚¬ìš©ì¤‘)';
      } else {
        input.placeholder = 'API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”';
        statusDot.className = 'settings-status-dot error';
        statusText.textContent = 'API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”';
      }
    };

    // Ruby ì½œë°±: ì—°ê²° í…ŒìŠ¤íŠ¸ ê²°ê³¼
    window.onConnectionTestResult = function(success, message) {
      if (success) {
        document.getElementById('settings-status-dot').className = 'settings-status-dot success';
        document.getElementById('settings-status-text').textContent = 'ì—°ê²° ì„±ê³µ';
      } else {
        document.getElementById('settings-status-dot').className = 'settings-status-dot error';
        document.getElementById('settings-status-text').textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + message;
      }
    };

    // íŒ¨ë„ ì„ íƒ ì´ë²¤íŠ¸
    document.getElementById('source-panel').addEventListener('click', (e) => {
      // ë²„íŠ¼ í´ë¦­ì€ ì œì™¸
      if (e.target.closest('button')) return;
      selectPanel('source');
    });

    document.getElementById('result-panel-1').addEventListener('click', (e) => {
      // ë²„íŠ¼ í´ë¦­ì€ ì œì™¸
      if (e.target.closest('button')) return;
      selectPanel('result');
    });

    // ì´ˆê¸° ì„ íƒ: source
    selectPanel('source');

    // RESULT íŒ¨ë„ 2ì°¨ ìƒì„± ë²„íŠ¼
    el.btnRegenerateResult.addEventListener('click', () => {
      if (!state.renderImage) return;
      const prompt = el.promptResult.value || el.promptSource.value || '';
      const negativePrompt = el.promptResultNegative.value || el.promptSourceNegative.value || '';
      sketchup.startRender(state.timePreset, state.lightSwitch, prompt, negativePrompt);
    });

    // RESULT Auto ë²„íŠ¼ - ë°”ë¡œ ìƒì„± (í˜„ì¬ ë¼ì´íŒ… ì„¤ì • ì „ë‹¬)
    el.btnAutoPromptResult.addEventListener('click', () => {
      sketchup.generateAutoPrompt('', state.timePreset, state.lightSwitch);
    });

    document.querySelectorAll('#time-group .seg-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#time-group .seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.timePreset = btn.dataset.time;
      });
    });

    document.querySelectorAll('#light-group .seg-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#light-group .seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.lightSwitch = btn.dataset.light;
      });
    });

    // â˜… Engine buttons (Gemini / Replicate)
    document.querySelectorAll('#engine-group .seg-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#engine-group .seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.engine = btn.dataset.engine;
        sketchup.setEngine(btn.dataset.engine);
        // ëª¨ë¸ ë“œë¡­ë‹¤ìš´ í•„í„°ë§ (í•´ë‹¹ ì—”ì§„ ëª¨ë¸ë§Œ í‘œì‹œ)
        updateModelDropdownForEngine(btn.dataset.engine);
      });
    });

    // ì—”ì§„ì— ë”°ë¼ ëª¨ë¸ ë“œë¡­ë‹¤ìš´ í•„í„°ë§
    function updateModelDropdownForEngine(engine) {
      const items = document.querySelectorAll('#model-dropdown-menu .dropdown-item');
      items.forEach(item => {
        if (item.dataset.engine === engine) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
      // ì²« ë²ˆì§¸ ë³´ì´ëŠ” ëª¨ë¸ ì„ íƒ
      const firstVisible = document.querySelector(`#model-dropdown-menu .dropdown-item[data-engine="${engine}"]`);
      if (firstVisible) {
        firstVisible.click();
      }
    }

    // Replicate í† í° ë¡œë“œ ì½œë°±
    function onReplicateTokenLoaded(maskedToken) {
      console.log('Replicate token loaded:', maskedToken ? 'exists' : 'none');
    }

    // ì—”ì§„ ë¡œë“œ ì½œë°±
    function onEngineLoaded(engine) {
      state.engine = engine;
      document.querySelectorAll('#engine-group .seg-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.engine === engine);
      });
      updateModelDropdownForEngine(engine);
    }

    // Size buttons
    document.querySelectorAll('#size-group .seg-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#size-group .seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.imageSize = btn.dataset.size;
      });
    });

    // Mirror button
    const btnMirror = document.getElementById('btn-mirror');
    btnMirror.addEventListener('click', () => {
      mirrorActive = !mirrorActive;
      btnMirror.classList.toggle('active', mirrorActive);
      btnMirror.textContent = mirrorActive ? 'Mirror ON' : 'Mirror';
      if (mirrorActive) {
        sketchup.startMirror();
      } else {
        sketchup.stopMirror();
      }
    });

    // Mirror update callback (Rubyì—ì„œ í˜¸ì¶œ) - ìµœì í™”
    let mirrorImageReady = true;
    function onMirrorUpdate(base64) {
      if (!mirrorActive || !mirrorImageReady) return;

      mirrorImageReady = false;

      // ì§ì ‘ src êµì²´ (ìƒˆ Image ê°ì²´ ì—†ì´)
      el.originalImage.src = 'data:image/jpeg;base64,' + base64;
      el.originalImage.style.display = 'block';
      el.originalEmpty.style.display = 'none';

      // ë‹¤ìŒ í”„ë ˆì„ ì¦‰ì‹œ í—ˆìš©
      mirrorImageReady = true;
    }

    // ë¯¸ëŸ¬ë§ ìƒíƒœ ì„¤ì • (Rubyì—ì„œ í˜¸ì¶œ)
    function setMirrorActive(active) {
      mirrorActive = active;
      btnMirror.classList.toggle('active', active);
      btnMirror.textContent = active ? 'Mirror ON' : 'Mirror';
    }

    // 2ì  íˆ¬ì‹œ ë²„íŠ¼
    document.getElementById('btn-2point').addEventListener('click', () => sketchup.apply2Point());

    // Camera movement buttons
    document.getElementById('cam-forward').addEventListener('click', () => sketchup.camMove('forward'));
    document.getElementById('cam-back').addEventListener('click', () => sketchup.camMove('back'));
    document.getElementById('cam-left').addEventListener('click', () => sketchup.camMove('left'));
    document.getElementById('cam-right').addEventListener('click', () => sketchup.camMove('right'));
    document.getElementById('cam-up').addEventListener('click', () => sketchup.camMove('up'));
    document.getElementById('cam-down').addEventListener('click', () => sketchup.camMove('down'));
    document.getElementById('cam-rot-left').addEventListener('click', () => sketchup.camRotate('left'));
    document.getElementById('cam-rot-right').addEventListener('click', () => sketchup.camRotate('right'));

    // Camera height presets
    document.querySelectorAll('#height-group .seg-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#height-group .seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        sketchup.camHeight(btn.dataset.height);
      });
    });

    // Camera FOV presets
    document.querySelectorAll('#fov-group .seg-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#fov-group .seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        sketchup.camFov(btn.dataset.fov);
      });
    });

    // WASD í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤
    const keyMap = {
      'w': { action: 'move', dir: 'forward', btn: 'cam-forward' },
      'W': { action: 'move', dir: 'forward', btn: 'cam-forward' },
      's': { action: 'move', dir: 'back', btn: 'cam-back' },
      'S': { action: 'move', dir: 'back', btn: 'cam-back' },
      'a': { action: 'move', dir: 'left', btn: 'cam-left' },
      'A': { action: 'move', dir: 'left', btn: 'cam-left' },
      'd': { action: 'move', dir: 'right', btn: 'cam-right' },
      'D': { action: 'move', dir: 'right', btn: 'cam-right' },
      'q': { action: 'move', dir: 'up', btn: 'cam-up' },
      'Q': { action: 'move', dir: 'up', btn: 'cam-up' },
      'e': { action: 'move', dir: 'down', btn: 'cam-down' },
      'E': { action: 'move', dir: 'down', btn: 'cam-down' },
      'z': { action: 'rotate', dir: 'left', btn: 'cam-rot-left' },
      'Z': { action: 'rotate', dir: 'left', btn: 'cam-rot-left' },
      'x': { action: 'rotate', dir: 'right', btn: 'cam-rot-right' },
      'X': { action: 'rotate', dir: 'right', btn: 'cam-rot-right' }
    };

    const activeKeys = new Set();
    const keyIntervals = {};

    document.addEventListener('keydown', (e) => {
      console.log('[í‚¤ë³´ë“œ] keydown:', e.key, 'target:', e.target.tagName);

      // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œì—ì„œë§Œ ë¬´ì‹œ (ìŠ¬ë¼ì´ë”ëŠ” í—ˆìš©)
      if (e.target.tagName === 'TEXTAREA') return;
      if (e.target.tagName === 'INPUT' && e.target.type !== 'range') return;

      const mapping = keyMap[e.key];
      console.log('[í‚¤ë³´ë“œ] mapping:', mapping);
      if (mapping) {
        const key = e.key.toLowerCase();

        // ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
        const btn = document.getElementById(mapping.btn);
        if (btn) btn.classList.add('active-key');

        // ì²˜ìŒ ëˆ„ë¥¼ ë•Œë§Œ interval ì‹œì‘
        if (!activeKeys.has(key)) {
          activeKeys.add(key);
          console.log('[í‚¤ë³´ë“œ] ì‹¤í–‰:', mapping.action, mapping.dir);

          // ì¦‰ì‹œ ì‹¤í–‰
          if (mapping.action === 'move') {
            sketchup.camMove(mapping.dir);
          } else if (mapping.action === 'rotate') {
            sketchup.camRotate(mapping.dir);
          }

          // ë°˜ë³µ ì‹¤í–‰ (100ms ê°„ê²©)
          keyIntervals[key] = setInterval(() => {
            if (mapping.action === 'move') {
              sketchup.camMove(mapping.dir);
            } else if (mapping.action === 'rotate') {
              sketchup.camRotate(mapping.dir);
            }
          }, 100);
        }
      }
    });

    document.addEventListener('keyup', (e) => {
      const mapping = keyMap[e.key];
      if (mapping) {
        const key = e.key.toLowerCase();
        activeKeys.delete(key);

        // interval ì •ë¦¬
        if (keyIntervals[key]) {
          clearInterval(keyIntervals[key]);
          delete keyIntervals[key];
        }

        // ë²„íŠ¼ í™œì„±í™” í•´ì œ
        const btn = document.getElementById(mapping.btn);
        if (btn) btn.classList.remove('active-key');
      }
    });

    // ì”¬ íƒ­ ì—…ë°ì´íŠ¸ (Rubyì—ì„œ í˜¸ì¶œ)
    function onScenesUpdate(scenesJson) {
      const scenes = JSON.parse(scenesJson);
      const tabsContainer = document.getElementById('scene-tabs');

      // íƒ­ ì´ˆê¸°í™”
      tabsContainer.innerHTML = '';

      // ì”¬ íƒ­ ì¶”ê°€
      scenes.forEach((scene, index) => {
        const tab = document.createElement('div');
        tab.className = 'scene-tab';
        if (index === 0) {
          tab.classList.add('active'); // ì²« ë²ˆì§¸ ì”¬ í™œì„±í™”
          // ì²« ì”¬ì„ í˜„ì¬ ì”¬ìœ¼ë¡œ ì„¤ì • (ì´ˆê¸°í™” ì‹œ)
          if (!state.currentScene) {
            state.currentScene = scene.name;
          }
        }
        tab.dataset.scene = scene.name;

        // ë Œë”ë§ ì¤‘ì¸ ì”¬ì´ë©´ ìŠ¤í”¼ë„ˆ ì¶”ê°€
        if (renderingScenes.has(scene.name)) {
          tab.classList.add('rendering');
          const spinner = document.createElement('div');
          spinner.className = 'scene-tab-spinner';
          tab.appendChild(spinner);
        }

        // ì”¬ ì´ë¦„ í…ìŠ¤íŠ¸
        const nameSpan = document.createElement('span');
        nameSpan.textContent = scene.name;
        tab.appendChild(nameSpan);

        tab.addEventListener('click', () => {
          // ì´ë¯¸ í™œì„± íƒ­ì´ë©´ ë¬´ì‹œ
          if (tab.classList.contains('active')) return;

          // í˜„ì¬ ì”¬ ìƒíƒœ ì €ì¥ & ìƒˆ ì”¬ ìƒíƒœ ë³µì›
          window.onSceneChanged(scene.name);

          // í™œì„± íƒ­ ë³€ê²½
          document.querySelectorAll('.scene-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // Rubyì— ì”¬ ì „í™˜ ìš”ì²­
          sketchup.selectScene(scene.name);
        });
        tabsContainer.appendChild(tab);
      });

      // + ë²„íŠ¼ ë‹¤ì‹œ ì¶”ê°€
      const addBtn = document.createElement('button');
      addBtn.className = 'scene-add-btn';
      addBtn.id = 'btn-add-scene';
      addBtn.title = 'í˜„ì¬ ë·°ë¥¼ ì”¬ìœ¼ë¡œ ì €ì¥';
      addBtn.textContent = '+';
      addBtn.addEventListener('click', () => sketchup.addScene());
      tabsContainer.appendChild(addBtn);
    }

    // ========================================
    // ê·¸ë¦¬ë“œ ê°€ì´ë“œ ì‹œìŠ¤í…œ
    // ========================================

    // ê·¸ë¦¬ë“œ ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function drawGrid(canvas, gridSize) {
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;

      ctx.clearRect(0, 0, w, h);

      // ì¤‘ì•™ ì¢Œí‘œ
      const centerX = w / 2;
      const centerY = h / 2;

      // ì¼ë°˜ ê·¸ë¦¬ë“œ ë¼ì¸ (ì—°í•œ ìƒ‰)
      ctx.strokeStyle = 'rgba(255, 100, 100, 0.25)';
      ctx.lineWidth = 1;

      // ìˆ˜ì§ì„  (ì¤‘ì•™ì—ì„œ ì–‘ìª½ìœ¼ë¡œ)
      for (let x = centerX % gridSize; x < w; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
      }

      // ìˆ˜í‰ì„  (ì¤‘ì•™ì—ì„œ ì–‘ìª½ìœ¼ë¡œ)
      for (let y = centerY % gridSize; y < h; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
      }

      // ì¤‘ì•™ ì‹­ì ë¼ì¸ (ì§„í•œ ìƒ‰)
      ctx.strokeStyle = 'rgba(255, 100, 100, 0.8)';
      ctx.lineWidth = 2;

      // ì¤‘ì•™ ìˆ˜í‰ì„ 
      ctx.beginPath();
      ctx.moveTo(0, centerY);
      ctx.lineTo(w, centerY);
      ctx.stroke();

      // ì¤‘ì•™ ìˆ˜ì§ì„ 
      ctx.beginPath();
      ctx.moveTo(centerX, 0);
      ctx.lineTo(centerX, h);
      ctx.stroke();

      // ì¤‘ì•™ ì‹­ì í‘œì‹œ
      ctx.fillStyle = 'rgba(255, 100, 100, 0.9)';
      ctx.font = 'bold 20px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('+', centerX, centerY);
    }

    // ê·¸ë¦¬ë“œ ìº”ë²„ìŠ¤ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ í¬ê¸°ì— ë§ì¶¤)
    function updateGridCanvas(canvas, img, slider, valueEl) {
      if (!img || img.style.display === 'none') return;
      canvas.width = img.offsetWidth;
      canvas.height = img.offsetHeight;
      canvas.style.display = 'block';
      const gridSize = parseInt(slider.value);
      valueEl.textContent = gridSize + 'px';
      drawGrid(canvas, gridSize);
    }

    // Source íŒ¨ë„
    const guideControlsSource = document.getElementById('guide-controls-source');
    const canvasSource = document.getElementById('guide-canvas-source');
    const sliderSource = document.getElementById('guide-slider-source');
    const valueSource = document.getElementById('guide-value-source');
    const lockSource = document.getElementById('guide-lock-source');
    const zoomSource = document.getElementById('guide-zoom-source');
    const zoomWrapperSource = document.getElementById('zoom-wrapper-source');
    const btnGuide = document.getElementById('btn-guide');
    let guideActiveSource = false;
    let guideLockedSource = false;

    btnGuide.addEventListener('click', () => {
      guideActiveSource = !guideActiveSource;
      btnGuide.classList.toggle('active', guideActiveSource);
      guideControlsSource.classList.toggle('hidden', !guideActiveSource);
      if (guideActiveSource) {
        updateGridCanvas(canvasSource, el.originalImage, sliderSource, valueSource);
      } else {
        canvasSource.style.display = 'none';
      }
    });

    sliderSource.addEventListener('input', () => {
      updateGridCanvas(canvasSource, el.originalImage, sliderSource, valueSource);
    });

    lockSource.addEventListener('click', () => {
      guideLockedSource = !guideLockedSource;
      lockSource.classList.toggle('locked', guideLockedSource);
      guideControlsSource.classList.toggle('locked', guideLockedSource);
    });

    // Zoom ìŠ¬ë¼ì´ë” (Source) - ì´ë¯¸ì§€+ê·¸ë¦¬ë“œ í•¨ê»˜ ì¤Œ
    zoomSource.addEventListener('input', () => {
      const scale = parseInt(zoomSource.value) / 100;
      zoomWrapperSource.style.transform = `scale(${scale})`;
    });

    // Result íŒ¨ë„
    const guideControlsResult = document.getElementById('guide-controls-result');
    const canvasResult = document.getElementById('guide-canvas-result');
    const sliderResult = document.getElementById('guide-slider-result');
    const valueResult = document.getElementById('guide-value-result');
    const lockResult = document.getElementById('guide-lock-result');
    const zoomResult = document.getElementById('guide-zoom-result');
    const zoomWrapperResult = document.getElementById('zoom-wrapper-result');
    const btnGuideResult = document.getElementById('btn-guide-result');
    let guideActiveResult = false;
    let guideLockedResult = false;

    btnGuideResult.addEventListener('click', () => {
      guideActiveResult = !guideActiveResult;
      btnGuideResult.classList.toggle('active', guideActiveResult);
      guideControlsResult.classList.toggle('hidden', !guideActiveResult);
      if (guideActiveResult) {
        updateGridCanvas(canvasResult, el.renderImage, sliderResult, valueResult);
      } else {
        canvasResult.style.display = 'none';
      }
    });

    sliderResult.addEventListener('input', () => {
      updateGridCanvas(canvasResult, el.renderImage, sliderResult, valueResult);
    });

    lockResult.addEventListener('click', () => {
      guideLockedResult = !guideLockedResult;
      lockResult.classList.toggle('locked', guideLockedResult);
      guideControlsResult.classList.toggle('locked', guideLockedResult);
    });

    // Zoom ìŠ¬ë¼ì´ë” (Result)
    zoomResult.addEventListener('input', () => {
      const scale = parseInt(zoomResult.value) / 100;
      zoomWrapperResult.style.transform = `scale(${scale})`;
    });

    // ì°½ ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
    window.addEventListener('resize', () => {
      if (guideActiveSource) {
        updateGridCanvas(canvasSource, el.originalImage, sliderSource, valueSource);
      }
      if (guideActiveResult) {
        updateGridCanvas(canvasResult, el.renderImage, sliderResult, valueResult);
      }
    });

    // íŒ¨ë„ í™•ì¥/ì¶•ì†Œ ê¸°ëŠ¥
    const sourcePanel = document.getElementById('source-panel');
    const resultPanel = document.getElementById('result-panel-1');
    const btnExpandSource = document.getElementById('btn-expand-source');
    const btnExpandResult = document.getElementById('btn-expand-result');

    // í™•ì¥ ì•„ì´ì½˜ SVG
    const expandIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="15 3 21 3 21 9"></polyline>
      <polyline points="9 21 3 21 3 15"></polyline>
      <line x1="21" y1="3" x2="14" y2="10"></line>
      <line x1="3" y1="21" x2="10" y2="14"></line>
    </svg>`;

    // ì¶•ì†Œ ì•„ì´ì½˜ SVG (ë¶„í•  ì•„ì´ì½˜)
    const collapseIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="4 14 10 14 10 20"></polyline>
      <polyline points="20 10 14 10 14 4"></polyline>
      <line x1="14" y1="10" x2="21" y2="3"></line>
      <line x1="3" y1="21" x2="10" y2="14"></line>
    </svg>`;

    let expandedPanel = null;

    function togglePanelExpand(panel, otherPanel, btn) {
      if (expandedPanel === panel) {
        // ì´ë¯¸ í™•ì¥ëœ ìƒíƒœë©´ ì¶•ì†Œ
        panel.classList.remove('fullscreen');
        otherPanel.classList.remove('hidden');
        btn.innerHTML = expandIcon;
        btn.title = 'Expand';
        // ë‹¤ë¥¸ íŒ¨ë„ ë²„íŠ¼ë„ í™•ì¥ ì•„ì´ì½˜ìœ¼ë¡œ ë³µêµ¬
        const otherBtn = otherPanel.querySelector('.panel-expand-btn');
        otherBtn.innerHTML = expandIcon;
        otherBtn.title = 'Expand';
        expandedPanel = null;
      } else {
        // í™•ì¥
        panel.classList.add('fullscreen');
        otherPanel.classList.add('hidden');
        btn.innerHTML = collapseIcon;
        btn.title = 'Split';
        expandedPanel = panel;
      }
    }

    btnExpandSource.addEventListener('click', () => {
      togglePanelExpand(sourcePanel, resultPanel, btnExpandSource);
    });

    btnExpandResult.addEventListener('click', () => {
      togglePanelExpand(resultPanel, sourcePanel, btnExpandResult);
    });

    // ì•„ì´ì½˜ ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.icon-menu-item').forEach(item => {
      item.addEventListener('click', () => {
        // í™œì„± ìƒíƒœ ë³€ê²½
        document.querySelectorAll('.icon-menu-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        // ë©”ë‰´ë³„ ë™ì‘
        const menuId = item.id;
        switch(menuId) {
          case 'menu-render':
            // Render ëª¨ë“œë¡œ ì „í™˜
            switchToRenderMode();
            break;
          case 'menu-camera':
            // Node Editor ëª¨ë“œë¡œ ì „í™˜
            switchToNodeMode();
            break;
          case 'menu-mix':
            // Mix ëª¨ë“œë¡œ ì „í™˜ (íŒì—… ëŒ€ì‹  ì¸ë¼ì¸)
            switchToMixMode();
            break;
          case 'menu-history':
            // íˆìŠ¤í† ë¦¬ íŒ¨ë„
            switchToRenderMode();
            break;
          case 'menu-help':
            // ë„ì›€ë§
            break;
          case 'menu-settings':
            openSettingsPanel();
            break;
        }
      });
    });

    // ========================================
    // ëª¨ë“œ ì „í™˜ (Render <-> Mix <-> Node)
    // ========================================
    let currentMode = 'render';

    function switchToRenderMode() {
      if (currentMode === 'render') return;
      currentMode = 'render';

      // Render ëª¨ë“œ UI í‘œì‹œ
      document.getElementById('render-sidebar').style.display = 'flex';
      document.getElementById('render-main-area').style.display = 'flex';

      // Mix ëª¨ë“œ UI ìˆ¨ê¹€
      document.getElementById('mix-mode-panel').classList.remove('active');
      document.getElementById('mix-main-area').classList.remove('active');
      document.getElementById('mix-options-panel').classList.remove('active');

      // Node ëª¨ë“œ UI ìˆ¨ê¹€ + Enlarge ëª¨ë“œ ë¦¬ì…‹
      document.getElementById('node-editor-container').classList.remove('active');
      document.getElementById('node-enlarged-preview').classList.remove('active');
      document.getElementById('node-canvas-area').classList.remove('minimized');
      document.querySelector('.node-inspector-preview').classList.remove('minimap-mode');
      document.getElementById('node-enlarge-btn').classList.remove('active');

      setStatus('Render Mode');
    }

    function switchToMixMode() {
      if (currentMode === 'mix') return;
      currentMode = 'mix';

      // Render ëª¨ë“œ UI ìˆ¨ê¹€
      document.getElementById('render-sidebar').style.display = 'none';
      document.getElementById('render-main-area').style.display = 'none';

      // Node ëª¨ë“œ UI ìˆ¨ê¹€ + Enlarge ëª¨ë“œ ë¦¬ì…‹
      document.getElementById('node-editor-container').classList.remove('active');
      document.getElementById('node-enlarged-preview').classList.remove('active');
      document.getElementById('node-canvas-area').classList.remove('minimized');
      document.querySelector('.node-inspector-preview').classList.remove('minimap-mode');
      document.getElementById('node-enlarge-btn').classList.remove('active');

      // Mix ëª¨ë“œ UI í‘œì‹œ
      document.getElementById('mix-mode-panel').classList.add('active');
      document.getElementById('mix-main-area').classList.add('active');
      document.getElementById('mix-options-panel').classList.add('active');

      // Mix ëª¨ë“œ ì´ˆê¸°í™” (ìº¡ì²˜ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¡œë“œ)
      initMixMode();
      setMixStatus('Mix Mode - ' + mixState.mode);
    }

    function switchToNodeMode() {
      if (currentMode === 'node') return;
      currentMode = 'node';

      // Render ëª¨ë“œ UI ìˆ¨ê¹€
      document.getElementById('render-sidebar').style.display = 'none';
      document.getElementById('render-main-area').style.display = 'none';

      // Mix ëª¨ë“œ UI ìˆ¨ê¹€
      document.getElementById('mix-mode-panel').classList.remove('active');
      document.getElementById('mix-main-area').classList.remove('active');
      document.getElementById('mix-options-panel').classList.remove('active');

      // Node ëª¨ë“œ UI í‘œì‹œ
      document.getElementById('node-editor-container').classList.add('active');

      // ì´ˆê¸° ë…¸ë“œ ì—†ìœ¼ë©´ ìë™ ìƒì„±
      if (nodeEditor.nodes.length === 0) {
        nodeEditor.addNode('source', 80, 120);
        nodeEditor.addNode('renderer', 480, 120);
        // ìë™ ì—°ê²°
        const srcN = nodeEditor.nodes.find(n => n.type === 'source');
        const renN = nodeEditor.nodes.find(n => n.type === 'renderer');
        if (srcN && renN) {
          nodeEditor.connect(srcN.id, renN.id);
        }
        // ì†ŒìŠ¤ ì¹´ë“œë¥¼ ì„ íƒëœ ìƒíƒœë¡œ ì‹œì‘
        if (srcN) nodeEditor.selectNode(srcN.id);
        // ë†’ì´ ìºì‹œ í›„ ì—°ê²°ì„  ì¬ë Œë”
        requestAnimationFrame(() => nodeEditor.renderConnections());
      }

      // Source ë…¸ë“œì— ì´ë¯¸ì§€ ìë™ ë¡œë“œ
      const sourceNode = nodeEditor.nodes.find(n => n.type === 'source');
      if (sourceNode && !sourceNode.data.image) {
        if (state.originalImage) {
          // Render ëª¨ë“œì—ì„œ ì´ë¯¸ ìº¡ì²˜í•œ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©
          sourceNode.data.image = state.originalImage;
          sourceNode.thumbnail = state.originalImage;
          sourceNode.dirty = false;
          nodeEditor.renderNode(sourceNode);
        } else {
          // ì—†ìœ¼ë©´ ìë™ ìº¡ì²˜
          nodeEditor.executeSourceNode(sourceNode);
        }
      }

      setStatus('Node Editor Mode');
    }

    // ========================================
    // 2ì°¨ ìƒì„± - ìƒˆ ê²°ê³¼ íŒ¨ë„ ë™ì  ìƒì„±
    // ========================================

    // ìƒˆ ê²°ê³¼ íŒ¨ë„ HTML ìƒì„±
    function createResultPanelHTML(id) {
      return `
        <div class="image-panel result-panel" id="result-panel-${id}" data-result-index="${id}">
          <div class="panel-label">
            <span>Result ${id}</span>
            <button class="panel-close-btn" id="btn-close-${id}" title="íŒ¨ë„ ë‹«ê¸°">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
            <button class="panel-expand-btn" id="btn-expand-result-${id}" title="Expand">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 3 21 3 21 9"></polyline>
                <polyline points="9 21 3 21 3 15"></polyline>
                <line x1="21" y1="3" x2="14" y2="10"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
              </svg>
            </button>
          </div>
          <div class="panel-content">
            <div class="empty-state" id="render-empty-${id}">Ready</div>
            <div class="image-zoom-container" id="zoom-container-result-${id}">
              <div class="image-zoom-wrapper" id="zoom-wrapper-result-${id}">
                <img id="render-image-${id}" style="display:none;">
              </div>
            </div>
            <div class="loading-overlay hidden" id="loading-${id}">
              <div class="loading-spinner"></div>
              <div class="loading-text" id="loading-text-${id}">Generating...</div>
              <div class="loading-subtext">Processing previous result</div>
              <div class="loading-progress"><div class="loading-progress-bar"></div></div>
            </div>
          </div>
        </div>
      `;
    }

    // ìƒˆ ê²°ê³¼ íŒ¨ë„ ì¶”ê°€
    function addResultPanel(sourceImage, sourcePanelId) {
      const newId = state.nextResultId;
      state.nextResultId++;
      state.resultPanels.push({ id: newId, image: null, sourceImage: sourceImage, sourcePanelId: sourcePanelId });

      // HTML ì‚½ì…
      const container = document.getElementById('image-container');
      const html = createResultPanelHTML(newId);
      container.insertAdjacentHTML('beforeend', html);

      // ìƒˆ íŒ¨ë„ì˜ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      bindResultPanelEvents(newId);

      return newId;
    }

    // ê²°ê³¼ íŒ¨ë„ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    function bindResultPanelEvents(id) {
      // ë‹«ê¸° ë²„íŠ¼
      const closeBtn = document.getElementById(`btn-close-${id}`);
      if (closeBtn) {
        closeBtn.addEventListener('click', () => removeResultPanel(id));
      }

      // 2ì°¨ ìƒì„± ë²„íŠ¼
      const regenBtn = document.getElementById(`btn-regenerate-${id}`);
      if (regenBtn) {
        regenBtn.addEventListener('click', () => startRegenerate(id));
      }
    }

    // ê²°ê³¼ íŒ¨ë„ ì œê±°
    function removeResultPanel(id) {
      // ì²« ë²ˆì§¸ ê²°ê³¼ íŒ¨ë„(Result 1)ì€ ì œê±° ë¶ˆê°€
      if (id === 1) return;

      const panel = document.getElementById(`result-panel-${id}`);
      if (panel) {
        panel.remove();
        state.resultPanels = state.resultPanels.filter(p => p.id !== id);
      }
    }

    // 2ì°¨ ìƒì„± ì‹œì‘
    function startRegenerate(sourcePanelId) {
      // ì†ŒìŠ¤ íŒ¨ë„ì˜ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
      const panelData = state.resultPanels.find(p => p.id === sourcePanelId);
      if (!panelData || !panelData.image) {
        setStatus('ì†ŒìŠ¤ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      // ìƒˆ ê²°ê³¼ íŒ¨ë„ ì¶”ê°€
      const newPanelId = addResultPanel(panelData.image, sourcePanelId);

      // í”„ë¡¬í”„íŠ¸ëŠ” SOURCE íŒ¨ë„ì—ì„œ ê°€ì ¸ì˜´
      const prompt = el.promptSource.value || '';

      // ë¡œë”© í‘œì‹œ
      const loadingEl = document.getElementById(`loading-${newPanelId}`);
      if (loadingEl) loadingEl.classList.remove('hidden');

      // Rubyì— 2ì°¨ ìƒì„± ìš”ì²­ (ì´ì „ ê²°ê³¼ ì´ë¯¸ì§€ë¥¼ ì†ŒìŠ¤ë¡œ)
      setStatus(`Result ${newPanelId} ìƒì„±ì¤‘...`);
      sketchup.regenerate(panelData.image, prompt, newPanelId);
    }

    // 2ì°¨ ìƒì„± ì™„ë£Œ ì½œë°± (Rubyì—ì„œ í˜¸ì¶œ)
    function onRegenerateComplete(base64, panelId) {
      const panelData = state.resultPanels.find(p => p.id === panelId);
      if (panelData) panelData.image = base64;

      // ì´ë¯¸ì§€ í‘œì‹œ
      const imgEl = document.getElementById(`render-image-${panelId}`);
      const emptyEl = document.getElementById(`render-empty-${panelId}`);
      const loadingEl = document.getElementById(`loading-${panelId}`);

      if (imgEl) {
        imgEl.src = 'data:image/png;base64,' + base64;
        imgEl.style.display = 'block';
      }
      if (emptyEl) emptyEl.style.display = 'none';
      if (loadingEl) loadingEl.classList.add('hidden');

      setStatus(`Result ${panelId} ì™„ë£Œ`);
    }

    // 2ì°¨ ìƒì„± ì—ëŸ¬ ì½œë°± (Rubyì—ì„œ í˜¸ì¶œ)
    function onRegenerateError(msg, panelId) {
      const loadingEl = document.getElementById(`loading-${panelId}`);
      if (loadingEl) loadingEl.classList.add('hidden');

      setStatus(`Result ${panelId} ì‹¤íŒ¨: ${msg}`);
    }


    // ========================================
    // Mix Mode - State & Elements
    // ========================================
    const mixState = {
      mode: 'add-remove',
      baseImage: null,
      baseImageBase64: null,
      objectImage: null,
      materialImage: null,
      floorplanImage: null,
      hotspots: [],
      selectedHotspot: null,
      brushSize: 30,
      brushColor: 'rgba(255, 59, 48, 0.5)',
      tool: 'brush',
      isDrawing: false,
      canvasScale: 1,
      sceneContext: null
    };

    const mixEl = {
      emptyState: document.getElementById('mix-empty-state'),
      canvasWrapper: document.getElementById('mix-canvas-wrapper'),
      mainCanvas: document.getElementById('mix-main-canvas'),
      maskCanvas: document.getElementById('mix-mask-canvas'),
      drawCanvas: document.getElementById('mix-draw-canvas'),
      loading: document.getElementById('mix-loading'),
      loadingText: document.getElementById('mix-loading-text'),
      loadingSubtext: document.getElementById('mix-loading-subtext'),
      statusText: document.getElementById('mix-status-text'),
      coordOverlay: document.getElementById('mix-coord-overlay'),
      coordWorld: document.getElementById('mix-coord-world'),
      coordScreen: document.getElementById('mix-coord-screen'),
      optionsTitle: document.getElementById('mix-options-title'),
      optionsSubtitle: document.getElementById('mix-options-subtitle'),
      btnApply: document.getElementById('mix-btn-apply'),
      btnBack: document.getElementById('mix-btn-back'),
      hotspotList: document.getElementById('mix-hotspot-list'),
      // Toolbars
      toolbarAddRemove: document.getElementById('mix-toolbar-add-remove'),
      toolbarMask: document.getElementById('mix-toolbar-mask'),
      toolbarFloorplan: document.getElementById('mix-toolbar-floorplan'),
      // Options panels
      optionsAddRemove: document.getElementById('mix-options-add-remove'),
      optionsInpaint: document.getElementById('mix-options-inpaint'),
      optionsMaterial: document.getElementById('mix-options-material'),
      optionsFloorplan: document.getElementById('mix-options-floorplan'),
      // Inputs
      brushSize: document.getElementById('mix-brush-size'),
      brushSizeValue: document.getElementById('mix-brush-size-value'),
      materialBrushSize: document.getElementById('mix-material-brush-size'),
      materialBrushSizeValue: document.getElementById('mix-material-brush-size-value')
    };

    function setMixStatus(text) {
      if (mixEl.statusText) mixEl.statusText.textContent = text;
    }

    // ========================================
    // Mix Mode - Initialization
    // ========================================
    function initMixMode() {
      // ì„ íƒëœ íŒ¨ë„ì˜ ì´ë¯¸ì§€ë¥¼ Mix ìº”ë²„ìŠ¤ì— ë¡œë“œ
      const selectedImage = getSelectedImage();
      if (selectedImage) {
        mixState.baseImageBase64 = selectedImage;
        loadMixBaseImage(selectedImage);
      }
      // ìŠ¤ì¼€ì¹˜ì—…ì— ì”¬ ì»¨í…ìŠ¤íŠ¸ ìš”ì²­
      callRuby('mix_get_scene_context');
    }

    function loadMixBaseImage(base64) {
      const img = new Image();
      img.onload = () => {
        mixState.baseImage = img;

        const container = document.querySelector('.mix-canvas-container');
        const maxW = container.clientWidth - 40;
        const maxH = container.clientHeight - 40;

        let w = img.width;
        let h = img.height;

        if (w > maxW) {
          const ratio = maxW / w;
          w = maxW;
          h = h * ratio;
        }
        if (h > maxH) {
          const ratio = maxH / h;
          h = maxH;
          w = w * ratio;
        }

        mixState.canvasScale = w / img.width;

        mixEl.mainCanvas.width = w;
        mixEl.mainCanvas.height = h;
        mixEl.maskCanvas.width = w;
        mixEl.maskCanvas.height = h;
        mixEl.drawCanvas.width = w;
        mixEl.drawCanvas.height = h;

        const ctx = mixEl.mainCanvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        mixEl.emptyState.classList.add('hidden');
        mixEl.canvasWrapper.classList.remove('hidden');

        setMixStatus('Image loaded');
        updateMixApplyButton();
      };
      img.src = 'data:image/png;base64,' + base64;
    }

    // ========================================
    // Mix Mode - Mode Switching
    // ========================================
    document.querySelectorAll('.mix-mode-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.mix-mode-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        switchMixSubMode(item.dataset.mixmode);
      });
    });

    function switchMixSubMode(mode) {
      mixState.mode = mode;

      // Hide all
      mixEl.toolbarAddRemove.classList.add('hidden');
      mixEl.toolbarMask.classList.add('hidden');
      mixEl.toolbarFloorplan.classList.add('hidden');
      mixEl.optionsAddRemove.classList.add('hidden');
      mixEl.optionsInpaint.classList.add('hidden');
      mixEl.optionsMaterial.classList.add('hidden');
      mixEl.optionsFloorplan.classList.add('hidden');

      // Show relevant
      switch(mode) {
        case 'add-remove':
          mixEl.toolbarAddRemove.classList.remove('hidden');
          mixEl.optionsAddRemove.classList.remove('hidden');
          mixEl.optionsTitle.textContent = 'Object Insert & Remove';
          mixEl.optionsSubtitle.textContent = '3D ì¢Œí‘œ ê¸°ë°˜ ì˜¤ë¸Œì íŠ¸ ë°°ì¹˜';
          mixEl.drawCanvas.style.cursor = 'crosshair';
          break;
        case 'inpaint':
          mixEl.toolbarMask.classList.remove('hidden');
          mixEl.optionsInpaint.classList.remove('hidden');
          mixEl.optionsTitle.textContent = 'Inpainting';
          mixEl.optionsSubtitle.textContent = 'ë§ˆìŠ¤í‚¹ ì˜ì—­ë§Œ ìˆ˜ì •';
          mixEl.drawCanvas.style.cursor = 'crosshair';
          break;
        case 'material':
          mixEl.toolbarMask.classList.remove('hidden');
          mixEl.optionsMaterial.classList.remove('hidden');
          mixEl.optionsTitle.textContent = 'Material Replace';
          mixEl.optionsSubtitle.textContent = 'ì¬ì§ˆ íˆ¬ì˜ ë° êµì²´';
          mixEl.drawCanvas.style.cursor = 'crosshair';
          break;
        case 'floorplan':
          mixEl.toolbarFloorplan.classList.remove('hidden');
          mixEl.optionsFloorplan.classList.remove('hidden');
          mixEl.optionsTitle.textContent = 'Floorplan to Isometric';
          mixEl.optionsSubtitle.textContent = '2D â†’ 3D ë³€í™˜';
          mixEl.drawCanvas.style.cursor = 'default';
          break;
      }

      // Clear mask
      const ctx = mixEl.maskCanvas.getContext('2d');
      ctx.clearRect(0, 0, mixEl.maskCanvas.width, mixEl.maskCanvas.height);

      updateMixApplyButton();
      setMixStatus('Mode: ' + mode);
    }

    // ========================================
    // Mix Mode - Apply Button Logic
    // ========================================
    function updateMixApplyButton() {
      let canApply = false;

      switch(mixState.mode) {
        case 'add-remove':
          canApply = mixState.baseImage && mixState.hotspots.length > 0;
          break;
        case 'inpaint':
          canApply = mixState.baseImage && hasMixMaskContent() &&
                     document.getElementById('mix-inpaint-instruction').value.trim();
          break;
        case 'material':
          canApply = mixState.baseImage && hasMixMaskContent() && mixState.materialImage;
          break;
        case 'floorplan':
          canApply = mixState.floorplanImage;
          break;
      }

      mixEl.btnApply.disabled = !canApply;
    }

    function hasMixMaskContent() {
      const ctx = mixEl.maskCanvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, mixEl.maskCanvas.width, mixEl.maskCanvas.height);
      return imageData.data.some((v, i) => i % 4 === 3 && v > 0);
    }

    // ========================================
    // Mix Mode - Drawing (Mask)
    // ========================================
    let mixLastX, mixLastY;

    mixEl.drawCanvas.addEventListener('mousedown', (e) => {
      if (mixState.mode !== 'inpaint' && mixState.mode !== 'material') return;

      mixState.isDrawing = true;
      const rect = mixEl.drawCanvas.getBoundingClientRect();
      mixLastX = e.clientX - rect.left;
      mixLastY = e.clientY - rect.top;
    });

    mixEl.drawCanvas.addEventListener('mousemove', (e) => {
      const rect = mixEl.drawCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Show coordinates
      if (mixState.mode === 'add-remove') {
        mixEl.coordOverlay.classList.add('visible');
        mixEl.coordScreen.textContent = `X: ${Math.round(x / mixState.canvasScale)} Y: ${Math.round(y / mixState.canvasScale)}`;
      }

      if (!mixState.isDrawing) return;
      if (mixState.mode !== 'inpaint' && mixState.mode !== 'material') return;

      const ctx = mixEl.maskCanvas.getContext('2d');
      const brushSize = mixState.mode === 'material' ?
        parseInt(mixEl.materialBrushSize.value) : parseInt(mixEl.brushSize.value);

      ctx.beginPath();
      ctx.lineWidth = brushSize;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      if (mixState.tool === 'eraser') {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = 'rgba(0,0,0,1)';
      } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = mixState.brushColor;
      }

      ctx.moveTo(mixLastX, mixLastY);
      ctx.lineTo(x, y);
      ctx.stroke();

      mixLastX = x;
      mixLastY = y;
    });

    mixEl.drawCanvas.addEventListener('mouseup', () => {
      mixState.isDrawing = false;
      updateMixApplyButton();
    });

    mixEl.drawCanvas.addEventListener('mouseleave', () => {
      mixState.isDrawing = false;
      mixEl.coordOverlay.classList.remove('visible');
    });

    // ========================================
    // Mix Mode - Tool Buttons
    // ========================================
    document.getElementById('mix-tool-brush').addEventListener('click', () => {
      mixState.tool = 'brush';
      document.getElementById('mix-tool-brush').classList.add('active');
      document.getElementById('mix-tool-eraser').classList.remove('active');
    });

    document.getElementById('mix-tool-eraser').addEventListener('click', () => {
      mixState.tool = 'eraser';
      document.getElementById('mix-tool-eraser').classList.add('active');
      document.getElementById('mix-tool-brush').classList.remove('active');
    });

    document.getElementById('mix-tool-clear-mask').addEventListener('click', () => {
      const ctx = mixEl.maskCanvas.getContext('2d');
      ctx.clearRect(0, 0, mixEl.maskCanvas.width, mixEl.maskCanvas.height);
      updateMixApplyButton();
    });

    // Brush size sliders
    mixEl.brushSize.addEventListener('input', () => {
      mixEl.brushSizeValue.textContent = mixEl.brushSize.value + 'px';
    });

    mixEl.materialBrushSize.addEventListener('input', () => {
      mixEl.materialBrushSizeValue.textContent = mixEl.materialBrushSize.value + 'px';
    });

    // Color buttons
    document.querySelectorAll('.mix-color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mix-color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        mixState.brushColor = btn.dataset.color;
      });
    });

    // ========================================
    // Mix Mode - File Uploads
    // ========================================
    document.getElementById('mix-upload-object').addEventListener('click', () => {
      document.getElementById('mix-object-file').click();
    });

    document.getElementById('mix-object-file').addEventListener('change', (e) => {
      handleMixFileUpload(e.target.files[0], 'object');
    });

    document.getElementById('mix-upload-material').addEventListener('click', () => {
      document.getElementById('mix-material-file').click();
    });

    document.getElementById('mix-material-file').addEventListener('change', (e) => {
      handleMixFileUpload(e.target.files[0], 'material');
    });

    document.getElementById('mix-upload-floorplan').addEventListener('click', () => {
      document.getElementById('mix-floorplan-file').click();
    });

    document.getElementById('mix-floorplan-file').addEventListener('change', (e) => {
      handleMixFileUpload(e.target.files[0], 'floorplan');
    });

    function handleMixFileUpload(file, type) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const base64 = e.target.result.split(',')[1];

        switch(type) {
          case 'object':
            mixState.objectImage = base64;
            document.getElementById('mix-object-preview').src = e.target.result;
            document.getElementById('mix-object-preview').classList.remove('hidden');
            document.getElementById('mix-upload-object').classList.add('has-image');
            break;
          case 'material':
            mixState.materialImage = base64;
            document.getElementById('mix-material-preview').src = e.target.result;
            document.getElementById('mix-material-preview').classList.remove('hidden');
            document.getElementById('mix-upload-material').classList.add('has-image');
            break;
          case 'floorplan':
            mixState.floorplanImage = base64;
            document.getElementById('mix-floorplan-preview').src = e.target.result;
            document.getElementById('mix-floorplan-preview').classList.remove('hidden');
            document.getElementById('mix-upload-floorplan').classList.add('has-image');
            break;
        }

        updateMixApplyButton();
      };
      reader.readAsDataURL(file);
    }

    // ========================================
    // Mix Mode - Hotspot System
    // ========================================
    mixEl.drawCanvas.addEventListener('click', (e) => {
      if (mixState.mode !== 'add-remove') return;

      const rect = mixEl.drawCanvas.getBoundingClientRect();
      const screenX = Math.round((e.clientX - rect.left) / mixState.canvasScale);
      const screenY = Math.round((e.clientY - rect.top) / mixState.canvasScale);

      // ìŠ¤ì¼€ì¹˜ì—…ì— 3D ì¢Œí‘œ ìš”ì²­
      callRuby('mix_get_3d_coord', screenX, screenY);
    });

    function onMixHotspotFromSketchUp(dataJson) {
      const data = JSON.parse(dataJson);

      const id = 'hotspot-' + Date.now();
      const objectName = document.getElementById('mix-object-name');
      const objectWidth = document.getElementById('mix-object-width');
      const objectHeight = document.getElementById('mix-object-height');
      const objectDepth = document.getElementById('mix-object-depth');

      const hotspot = {
        id,
        position: data.position,
        normal: data.normal,
        screenPos: data.screen_pos,
        floorReference: data.floor_reference,
        name: objectName.value || 'Object ' + (mixState.hotspots.length + 1),
        image: mixState.objectImage,
        estimatedSize: {
          width: parseInt(objectWidth.value) || 500,
          height: parseInt(objectHeight.value) || 800,
          depth: parseInt(objectDepth.value) || 500
        },
        scale: 1.0,
        rotation: 0
      };

      mixState.hotspots.push(hotspot);
      renderMixHotspots();
      updateMixHotspotList();
      updateMixApplyButton();

      setMixStatus(`Hotspot added at (${Math.round(data.position.x)}, ${Math.round(data.position.y)}, ${Math.round(data.position.z)}) mm`);
    }

    function renderMixHotspots() {
      // Remove existing markers
      document.querySelectorAll('.mix-hotspot-marker').forEach(m => m.remove());

      mixState.hotspots.forEach((h, i) => {
        const marker = document.createElement('div');
        marker.className = 'mix-hotspot-marker';
        marker.textContent = i + 1;

        const screenX = h.screenPos.x * mixState.canvasScale;
        const screenY = h.screenPos.y * mixState.canvasScale;
        marker.style.left = screenX + 'px';
        marker.style.top = screenY + 'px';
        marker.dataset.id = h.id;

        if (mixState.selectedHotspot === h.id) {
          marker.classList.add('selected');
        }

        marker.addEventListener('click', (e) => {
          e.stopPropagation();
          mixState.selectedHotspot = h.id;
          renderMixHotspots();
          updateMixHotspotList();
        });

        mixEl.canvasWrapper.appendChild(marker);
      });
    }

    function updateMixHotspotList() {
      if (mixState.hotspots.length === 0) {
        mixEl.hotspotList.innerHTML = `
          <div class="mix-empty-state" style="font-size:11px;padding:16px;color:#555;">
            ìŠ¤ì¼€ì¹˜ì—… ë·°í¬íŠ¸ì—ì„œ í´ë¦­í•˜ì—¬ í•«ìŠ¤íŒŸì„ ì¶”ê°€í•˜ì„¸ìš”
          </div>`;
        return;
      }

      mixEl.hotspotList.innerHTML = mixState.hotspots.map((h, i) => `
        <div class="mix-hotspot-item ${mixState.selectedHotspot === h.id ? 'selected' : ''}" data-id="${h.id}">
          <div class="mix-hotspot-item-header">
            <div class="mix-hotspot-item-num">${i + 1}</div>
            <div class="mix-hotspot-item-info">
              <div class="mix-hotspot-item-name">${h.name}</div>
              <div class="mix-hotspot-item-coords">
                X: ${Math.round(h.position.x)} Y: ${Math.round(h.position.y)} Z: ${Math.round(h.position.z)} mm
              </div>
            </div>
            <button class="mix-hotspot-item-delete" data-id="${h.id}">
              <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
      `).join('');

      // Event handlers
      mixEl.hotspotList.querySelectorAll('.mix-hotspot-item').forEach(item => {
        item.addEventListener('click', () => {
          mixState.selectedHotspot = item.dataset.id;
          renderMixHotspots();
          updateMixHotspotList();
        });
      });

      mixEl.hotspotList.querySelectorAll('.mix-hotspot-item-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          mixState.hotspots = mixState.hotspots.filter(h => h.id !== id);
          if (mixState.selectedHotspot === id) mixState.selectedHotspot = null;
          renderMixHotspots();
          updateMixHotspotList();
          updateMixApplyButton();
        });
      });
    }

    // ========================================
    // Mix Mode - Apply & Callbacks
    // ========================================
    mixEl.btnApply.addEventListener('click', applyMix);
    mixEl.btnBack.addEventListener('click', () => {
      // ë©”ë‰´ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.icon-menu-item').forEach(i => i.classList.remove('active'));
      document.getElementById('menu-render').classList.add('active');
      switchToRenderMode();
    });

    function applyMix() {
      showMixLoading('Processing...', 'AIê°€ ì”¬ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤');

      const data = {
        mode: mixState.mode,
        sceneContext: mixState.sceneContext
      };

      switch(mixState.mode) {
        case 'add-remove':
          data.baseImage = mixState.baseImageBase64;
          data.hotspots = mixState.hotspots.map(h => ({
            position: h.position,
            normal: h.normal,
            screenPos: h.screenPos,
            floorReference: h.floorReference,
            name: h.name,
            image: h.image,
            estimatedSize: h.estimatedSize,
            scale: h.scale,
            rotation: h.rotation
          }));
          data.instruction = document.getElementById('mix-object-instruction').value;
          break;

        case 'inpaint':
          data.baseImage = mixState.baseImageBase64;
          data.maskImage = mixCanvasToBase64(mixEl.maskCanvas);
          data.instruction = document.getElementById('mix-inpaint-instruction').value;
          data.preserve = {
            lighting: document.getElementById('mix-preserve-lighting').checked,
            style: document.getElementById('mix-preserve-style').checked
          };
          break;

        case 'material':
          data.baseImage = mixState.baseImageBase64;
          data.maskImage = mixCanvasToBase64(mixEl.maskCanvas);
          data.materialImage = mixState.materialImage;
          data.description = document.getElementById('mix-material-description').value;
          break;

        case 'floorplan':
          data.floorplanImage = mixState.floorplanImage;
          data.parameters = {
            wallHeight: parseInt(document.getElementById('mix-wall-height').value),
            wallThickness: parseInt(document.getElementById('mix-wall-thickness').value),
            style: document.getElementById('mix-floorplan-style').value
          };
          data.instruction = document.getElementById('mix-floorplan-instruction').value;
          break;
      }

      callRuby('mix_apply', JSON.stringify(data));
    }

    function mixCanvasToBase64(canvas) {
      return canvas.toDataURL('image/png').split(',')[1];
    }

    function showMixLoading(text, subtext) {
      mixEl.loadingText.textContent = text || 'Processing...';
      mixEl.loadingSubtext.textContent = subtext || '';
      mixEl.loading.classList.remove('hidden');
    }

    function hideMixLoading() {
      mixEl.loading.classList.add('hidden');
    }

    // Ruby Callbacks for Mix Mode
    function onMixSceneContextLoaded(contextJson) {
      mixState.sceneContext = JSON.parse(contextJson);
      document.getElementById('mix-scene-info').textContent =
        `Camera: FOV ${mixState.sceneContext.camera.fov.toFixed(0)}Â°`;
    }

    function onMixCoordReceived(coordJson) {
      const data = JSON.parse(coordJson);
      mixEl.coordWorld.textContent = `X: ${Math.round(data.position.x)} Y: ${Math.round(data.position.y)} Z: ${Math.round(data.position.z)}`;
      onMixHotspotFromSketchUp(coordJson);
    }

    function onMixComplete(resultBase64) {
      hideMixLoading();

      const img = new Image();
      img.onload = () => {
        const ctx = mixEl.mainCanvas.getContext('2d');
        ctx.drawImage(img, 0, 0, mixEl.mainCanvas.width, mixEl.mainCanvas.height);

        // Clear
        const maskCtx = mixEl.maskCanvas.getContext('2d');
        maskCtx.clearRect(0, 0, mixEl.maskCanvas.width, mixEl.maskCanvas.height);
        mixState.hotspots = [];
        mixState.selectedHotspot = null;
        renderMixHotspots();
        updateMixHotspotList();

        setMixStatus('Mix complete!');
      };
      img.src = 'data:image/png;base64,' + resultBase64;
    }

    function onMixError(message) {
      hideMixLoading();
      setMixStatus('Error: ' + message);
      alert('Mix Error: ' + message);
    }

    // Input listeners for Apply button
    document.getElementById('mix-inpaint-instruction').addEventListener('input', updateMixApplyButton);
    document.getElementById('mix-material-description').addEventListener('input', updateMixApplyButton);

    // ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ - ëª¨ë¸ ì„ íƒ
    let currentModelValue = 'gemini-2.0-flash-exp';
    const modelDropdown = document.getElementById('model-dropdown');
    const modelDropdownSelected = document.getElementById('model-dropdown-selected');
    const modelDropdownMenu = document.getElementById('model-dropdown-menu');
    const modelSelectedText = document.getElementById('model-selected-text');

    // ë“œë¡­ë‹¤ìš´ í† ê¸€
    modelDropdownSelected.addEventListener('click', function(e) {
      e.stopPropagation();
      modelDropdown.classList.toggle('open');
    });

    // ì•„ì´í…œ ì„ íƒ
    modelDropdownMenu.querySelectorAll('.dropdown-item').forEach(function(item) {
      item.addEventListener('click', function(e) {
        e.stopPropagation();
        const value = this.dataset.value;
        const text = this.childNodes[0].textContent.trim();

        // ì´ì „ ì„ íƒ í•´ì œ
        modelDropdownMenu.querySelectorAll('.dropdown-item').forEach(function(i) {
          i.classList.remove('selected');
        });

        // ìƒˆ ì„ íƒ
        this.classList.add('selected');
        modelSelectedText.textContent = text;
        currentModelValue = value;

        // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        modelDropdown.classList.remove('open');

        // Rubyì— ì €ì¥
        sketchup.saveModel(value);
      });
    });

    // ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener('click', function(e) {
      if (!modelDropdown.contains(e.target)) {
        modelDropdown.classList.remove('open');
      }
    });

    // í˜„ì¬ ëª¨ë¸ ê°’ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    function getSelectedModel() {
      return currentModelValue;
    }

    // Rubyì—ì„œ í˜¸ì¶œë˜ëŠ” ì½œë°± - ëª¨ë¸ ë¡œë“œ
    function onModelLoaded(model) {
      if (model) {
        currentModelValue = model;
        // data-valueë¡œ ì§ì ‘ ì°¾ê¸° (íŠ¹ìˆ˜ë¬¸ì ëŒ€ì‘)
        const items = modelDropdownMenu.querySelectorAll('.dropdown-item');
        let found = null;
        items.forEach(function(item) {
          if (item.dataset.value === model) {
            found = item;
          }
        });
        if (found) {
          items.forEach(function(i) {
            i.classList.remove('selected');
          });
          found.classList.add('selected');
          modelSelectedText.textContent = found.childNodes[0].textContent.trim();
        }
      }
    }

    // ì¦‰ì‹œ ì´ˆê¸°í™” (ì§€ì—° ì—†ì´)
    sketchup.checkApiStatus();
    sketchup.getScenes();
    sketchup.loadModel();
    sketchup.loadHistory();  // íˆìŠ¤í† ë¦¬ ë¡œë“œ

    // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
    setTimeout(function() {
      const loader = document.getElementById('app-loader');
      if (loader) {
        loader.classList.add('hidden');
        setTimeout(function() {
          loader.style.display = 'none';
        }, 500);
      }
    }, 800);

    // ========================================
    // Node Editor System
    // ========================================
    const nodeEditor = {
      nodes: [],
      connections: [],
      nextNodeId: 1,
      selectedNode: null,
      draggingNode: null,
      dragOffset: { x: 0, y: 0 },
      connecting: null, // ì—°ê²° ì¤‘ì¸ ë…¸ë“œ ID
      dirty: false,

      // ë…¸ë“œ ì¶”ê°€
      addNode: function(type, x, y) {
        const node = {
          id: this.nextNodeId++,
          type: type,
          x: x,
          y: y,
          dirty: true,
          data: this.getDefaultData(type),
          thumbnail: null
        };
        this.nodes.push(node);
        this.renderNode(node);
        this.selectNode(node.id);
        this.markDirty();
        return node;
      },

      // ê°™ì€ íƒ€ì…ì˜ ë…¸ë“œ ì¤‘ ê°€ì¥ ì•„ë˜ì— ìˆëŠ” ë…¸ë“œë¥¼ ì°¾ì•„ì„œ ê·¸ ì•„ë˜ì— ë°°ì¹˜
      addNodeBelow: function(clickedNode, newType) {
        // ê°™ì€ íƒ€ì…ì˜ ê¸°ì¡´ ë…¸ë“œë“¤ ì¤‘ ê°€ì¥ ì•„ë˜(yê°€ í°) ë…¸ë“œ ì°¾ê¸°
        const sameTypeNodes = this.nodes.filter(n => n.type === newType);
        let targetX, targetY;

        if (sameTypeNodes.length > 0) {
          // ê°™ì€ íƒ€ì… ì¤‘ ê°€ì¥ ì•„ë˜ ë…¸ë“œ ì°¾ê¸°
          const bottomNode = sameTypeNodes.reduce((a, b) => a.y > b.y ? a : b);
          targetX = bottomNode.x;
          targetY = bottomNode.y + 260; // ì¹´ë“œ ë†’ì´ + ê°„ê²©
        } else {
          // ê°™ì€ íƒ€ì…ì´ ì—†ìœ¼ë©´ í´ë¦­í•œ ë…¸ë“œ ê¸°ì¤€ ë°°ì¹˜
          if (newType === 'source') {
            // ì†ŒìŠ¤ ì¹´ë“œê°€ ì—†ìœ¼ë©´ í´ë¦­í•œ ì¹´ë“œ ì™¼ìª½ì— ì•„ë˜ë¡œ
            const sourceNodes = this.nodes.filter(n => n.type === 'source');
            targetX = sourceNodes.length > 0 ? sourceNodes[0].x : 80;
            targetY = clickedNode.y + 260;
          } else if (newType === 'renderer') {
            const rendererNodes = this.nodes.filter(n => n.type === 'renderer');
            targetX = rendererNodes.length > 0 ? rendererNodes[0].x : 480;
            targetY = clickedNode.y + 260;
          } else {
            // animation - renderer ì•„ë˜ì— ë°°ì¹˜
            const rendererNodes = this.nodes.filter(n => n.type === 'renderer');
            if (rendererNodes.length > 0) {
              const bottomRenderer = rendererNodes.reduce((a, b) => a.y > b.y ? a : b);
              targetX = bottomRenderer.x;
              targetY = bottomRenderer.y + 260;
            } else {
              targetX = 480;
              targetY = clickedNode.y + 260;
            }
          }
        }

        const newNode = this.addNode(newType, targetX, targetY);

        // ìë™ ì—°ê²°: ì†ŒìŠ¤â†’ë Œë”ëŸ¬, ë Œë”ëŸ¬â†’ì• ë‹ˆë©”ì´ì…˜
        if (newType === 'renderer') {
          const sourceNodes = this.nodes.filter(n => n.type === 'source');
          if (sourceNodes.length > 0) {
            this.connect(sourceNodes[sourceNodes.length - 1].id, newNode.id);
          }
        } else if (newType === 'animation') {
          const rendererNodes = this.nodes.filter(n => n.type === 'renderer');
          if (rendererNodes.length > 0) {
            this.connect(rendererNodes[rendererNodes.length - 1].id, newNode.id);
          }
        }
      },

      // ê¸°ë³¸ ë°ì´í„°
      getDefaultData: function(type) {
        if (type === 'source') {
          return {
            time: 'day',
            light: 'on',
            image: null
          };
        } else if (type === 'renderer') {
          return {
            mode: 'nanobanana-pro',
            resolution: '2048',
            aspect: 'original',
            presets: [],
            customPrompt: '',
            negativePrompt: ''
          };
        } else if (type === 'animation') {
          return {
            fps: 24,
            duration: 3,
            style: 'smooth',
            prompt: ''
          };
        }
        return {};
      },

      // ë…¸ë“œ ë Œë”ë§ (positionOnly=trueë©´ ìœ„ì¹˜ë§Œ ì—…ë°ì´íŠ¸, innerHTML ì¬ìƒì„± ì•ˆí•¨)
      renderNode: function(node, positionOnly) {
        const canvas = document.getElementById('node-canvas');
        let el = document.getElementById('node-' + node.id);
        const isNew = !el;

        if (isNew) {
          el = document.createElement('div');
          el.id = 'node-' + node.id;
          el.className = 'node node-' + node.type;
          if (node.dirty) el.classList.add('dirty');
          el.style.willChange = 'transform';
          canvas.appendChild(el);

          // ë“œë˜ê·¸ ì´ë²¤íŠ¸
          el.addEventListener('mousedown', (e) => this.onNodeMouseDown(e, node));
          el.addEventListener('click', (e) => {
            e.stopPropagation();
            this.selectNode(node.id);
          });
        }

        // transformìœ¼ë¡œ ìœ„ì¹˜ ì§€ì • (left/top ëŒ€ì‹  GPU ê°€ì†)
        el.style.transform = `translate(${node.x}px, ${node.y}px)`;
        el.classList.toggle('dirty', node.dirty);
        el.classList.toggle('selected', this.selectedNode === node.id);

        // ë“œë˜ê·¸ ì¤‘ì´ë©´ ìœ„ì¹˜ë§Œ ì—…ë°ì´íŠ¸í•˜ê³  ë
        if (positionOnly) return;

        // ë‚´ìš© ë³€ê²½ í•„ìš” ì—¬ë¶€ ì²´í¬ (ìºì‹œëœ ìƒíƒœì™€ ë¹„êµ)
        const currentState = (node.thumbnail || '') + '|' + node.type + '|' + node.dirty;
        if (!isNew && el._cachedState === currentState) return;
        el._cachedState = currentState;

        const icons = {
          source: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
          renderer: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.435,3.06H5.565a2.5,2.5,0,0,0-2.5,2.5V18.44a2.507,2.507,0,0,0,2.5,2.5h12.87a2.507,2.507,0,0,0,2.5-2.5V5.56A2.5,2.5,0,0,0,18.435,3.06ZM4.065,5.56a1.5,1.5,0,0,1,1.5-1.5h12.87a1.5,1.5,0,0,1,1.5,1.5v8.66l-3.88-3.88a1.509,1.509,0,0,0-2.12,0l-4.56,4.57a.513.513,0,0,1-.71,0l-.56-.56a1.522,1.522,0,0,0-2.12,0l-1.92,1.92Zm15.87,12.88a1.5,1.5,0,0,1-1.5,1.5H5.565a1.5,1.5,0,0,1-1.5-1.5v-.75L6.7,15.06a.5.5,0,0,1,.35-.14.524.524,0,0,1,.36.14l.55.56a1.509,1.509,0,0,0,2.12,0l4.57-4.57a.5.5,0,0,1,.71,0l4.58,4.58Z"/><path d="M8.062,10.565a2.5,2.5,0,1,1,2.5-2.5A2.5,2.5,0,0,1,8.062,10.565Zm0-4a1.5,1.5,0,1,0,1.5,1.5A1.5,1.5,0,0,0,8.062,6.565Z"/></svg>',
          animation: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="20" height="16" rx="3"/><path d="M2 9h20M2 15h20M7 4v16M12 4v16M17 4v16"/><path d="M10 11.5l4 2.5-4 2.5z" fill="currentColor" stroke="none"/></svg>'
        };
        const icon = icons[node.type] || icons.renderer;

        const titles = { source: 'Source', renderer: 'Renderer', animation: 'Animation' };
        const title = titles[node.type] || node.type;
        const hasImage = !!node.thumbnail;

        // ë¯¸ë‹ˆíˆ´ë°”: ì´ë¯¸ì§€ ì—†ëŠ” ì¹´ë“œëŠ” íˆ´ë°” í‘œì‹œ ì•ˆí•¨
        const showToolbar = hasImage;
        const showAnimation = node.type === 'renderer' && hasImage;
        const animBtn = showAnimation ? `
            <button class="node-mini-toolbar-btn" data-add="animation" title="Add Animation">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="20" height="16" rx="3"/><path d="M2 9h20"/><path d="M7 4v5M12 4v5M17 4v5"/><path d="M10 14l5 3-5 3z" fill="currentColor" stroke="none"/></svg>
            </button>` : '';
        const miniToolbar = showToolbar ? `
          <div class="node-mini-toolbar">
            <button class="node-mini-toolbar-btn" data-add="source" title="Add Source">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="3" width="14" height="18" rx="2"/><rect x="7" y="6" width="8" height="5" rx="1"/><line x1="7" y1="14" x2="15" y2="14"/><line x1="7" y1="17" x2="12" y2="17"/><circle cx="17" cy="18" r="4.5" fill="#1c2128" stroke="currentColor" stroke-width="1.5"/><line x1="17" y1="16" x2="17" y2="20"/><line x1="15" y1="18" x2="19" y2="18"/></svg>
            </button>
            <button class="node-mini-toolbar-btn" data-add="renderer" title="Add Renderer">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="10" r="2"/><path d="M3 17l4.5-4.5a1.5 1.5 0 0 1 2.1 0l3.9 3.9"/><path d="M14 15l1.5-1.5a1.5 1.5 0 0 1 2.1 0L21 17"/><path d="M17 3l2 2.5L17 8" stroke-width="1.5" fill="none"/></svg>
            </button>${animBtn}
          </div>` : '';

        if (hasImage) {
          const existingImg = el.querySelector('.node-thumbnail img');
          if (existingImg && el._hasImage) {
            existingImg.src = 'data:image/png;base64,' + node.thumbnail;
            return;
          }
          el._hasImage = true;
          el.innerHTML = `${miniToolbar}
            <div class="node-thumbnail" style="border-radius:6px;">
              <img src="data:image/png;base64,${node.thumbnail}">
            </div>
            <div class="node-ports">
              ${node.type === 'source' ? '<div></div>' : '<div class="node-port node-port-input" data-port="input"></div>'}
              <div class="node-port node-port-output" data-port="output"></div>
            </div>
            <div class="node-progress"><div class="node-progress-bar"></div></div>
            <div class="node-label-outside">
              <div class="node-title">${title}</div>
            </div>
          `;
        } else {
          el._hasImage = false;
          el.innerHTML = `${miniToolbar}
            <div class="node-thumbnail">
              <div class="node-header-icon">${icon}</div>
            </div>
            <div class="node-ports">
              ${node.type === 'source' ? '<div></div>' : '<div class="node-port node-port-input" data-port="input"></div>'}
              <div class="node-port node-port-output" data-port="output"></div>
            </div>
            <div class="node-progress"><div class="node-progress-bar"></div></div>
            <div class="node-label-outside">
              <div class="node-title">${title}</div>
            </div>
          `;
        }

        // í¬íŠ¸ ì´ë²¤íŠ¸
        el.querySelectorAll('.node-port').forEach(port => {
          port.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            this.startConnect(node.id, port.dataset.port);
          });
          port.addEventListener('mouseup', (e) => {
            e.stopPropagation();
            this.endConnect(node.id, port.dataset.port);
          });
        });

        // ë¯¸ë‹ˆíˆ´ë°” ë²„íŠ¼ ì´ë²¤íŠ¸
        el.querySelectorAll('.node-mini-toolbar-btn').forEach(btn => {
          btn.addEventListener('mousedown', (e) => e.stopPropagation());
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const addType = btn.dataset.add;
            this.addNodeBelow(node, addType);
          });
        });

        // ë†’ì´ ìºì‹œ (ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ì¸¡ì • - í˜„ì¬ í”„ë ˆì„ì˜ ë ˆì´ì•„ì›ƒ ê³„ì‚° ì•ˆ í•¨)
        requestAnimationFrame(() => {
          el._cachedHeight = el.offsetHeight;
        });
      },

      // ë…¸ë“œ ì„ íƒ (CSS í´ë˜ìŠ¤ë§Œ í† ê¸€, innerHTML ì¬ìƒì„± ì•ˆí•¨)
      selectNode: function(nodeId) {
        const prevId = this.selectedNode;
        this.selectedNode = nodeId;
        // ì´ì „ ì„ íƒ í•´ì œ
        if (prevId) {
          const prevEl = document.getElementById('node-' + prevId);
          if (prevEl) prevEl.classList.remove('selected');
        }
        // ìƒˆ ì„ íƒ ì ìš©
        if (nodeId) {
          const newEl = document.getElementById('node-' + nodeId);
          if (newEl) newEl.classList.add('selected');
        }
        this.updateInspector();
      },

      // Inspector ì—…ë°ì´íŠ¸
      updateInspector: function() {
        const emptyEl = document.getElementById('node-inspector-empty');
        const sourceEl = document.getElementById('inspector-source');
        const rendererEl = document.getElementById('inspector-renderer');
        const previewEl = document.getElementById('node-preview-image');
        const bottomPrompt = document.getElementById('node-prompt-input');
        const bottomNegative = document.getElementById('node-prompt-negative-input');
        const negativeRow = document.querySelector('.node-prompt-negative-row');
        const autoBtn = document.getElementById('node-prompt-auto-btn');

        emptyEl.classList.add('hidden');
        sourceEl.classList.add('hidden');
        rendererEl.classList.add('hidden');

        if (!this.selectedNode) {
          emptyEl.classList.remove('hidden');
          previewEl.innerHTML = '<span class="node-inspector-preview-empty">No preview</span>';
          bottomPrompt.value = '';
          bottomPrompt.disabled = true;
          bottomPrompt.placeholder = 'Select a Renderer node to enter prompt...';
          bottomNegative.value = '';
          negativeRow.classList.remove('visible');
          autoBtn.disabled = true;
          return;
        }

        const node = this.nodes.find(n => n.id === this.selectedNode);
        if (!node) {
          emptyEl.classList.remove('hidden');
          previewEl.innerHTML = '<span class="node-inspector-preview-empty">No preview</span>';
          return;
        }

        // Preview ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
        if (node.data.image) {
          previewEl.innerHTML = '<img src="data:image/png;base64,' + node.data.image + '" alt="Preview">';
        } else {
          previewEl.innerHTML = '<span class="node-inspector-preview-empty">No preview</span>';
        }
        // Enlarge ëª¨ë“œ í™œì„± ì‹œ enlarged ì´ë¯¸ì§€ë„ ë™ê¸°í™”
        var enlargedPreview = document.getElementById('node-enlarged-preview');
        if (enlargedPreview && enlargedPreview.classList.contains('active')) {
          var enlargedImage = document.getElementById('node-enlarged-image');
          if (node.data.image) {
            enlargedImage.innerHTML = '<img src="data:image/png;base64,' + node.data.image + '" alt="Enlarged Preview">';
          } else {
            enlargedImage.innerHTML = '<span class="node-inspector-preview-empty">No preview</span>';
          }
        }

        if (node.type === 'source') {
          sourceEl.classList.remove('hidden');
          // Time ë²„íŠ¼ ìƒíƒœ
          sourceEl.querySelectorAll('[data-time]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.time === node.data.time);
          });
          // Light ë²„íŠ¼ ìƒíƒœ
          sourceEl.querySelectorAll('[data-light]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.light === node.data.light);
          });
          bottomPrompt.value = '';
          bottomPrompt.disabled = true;
          bottomPrompt.placeholder = 'Select a Renderer node to enter prompt...';
          bottomNegative.value = '';
          negativeRow.classList.remove('visible');
          autoBtn.disabled = true;
        } else if (node.type === 'renderer') {
          rendererEl.classList.remove('hidden');
          // Resolution ë²„íŠ¼ ìƒíƒœ
          rendererEl.querySelectorAll('[data-res]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.res === node.data.resolution);
          });
          // Aspect ë²„íŠ¼ ìƒíƒœ
          rendererEl.querySelectorAll('[data-aspect]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.aspect === node.data.aspect);
          });
          // Presets ë²„íŠ¼ ìƒíƒœ
          rendererEl.querySelectorAll('[data-preset]').forEach(btn => {
            btn.classList.toggle('active', node.data.presets.includes(btn.dataset.preset));
          });
          // Custom prompt - Inspectorì™€ í•˜ë‹¨ ë°” ë™ê¸°í™”
          const customPrompt = node.data.customPrompt || '';
          document.getElementById('node-custom-prompt').value = customPrompt;
          bottomPrompt.value = customPrompt;
          bottomPrompt.disabled = false;
          bottomPrompt.placeholder = 'Enter rendering prompt...';
          // Negative prompt ë™ê¸°í™”
          bottomNegative.value = node.data.negativePrompt || '';
          negativeRow.classList.add('visible');
          autoBtn.disabled = false;
        }
      },

      // ë“œë˜ê·¸ ì‹œì‘
      onNodeMouseDown: function(e, node) {
        if (e.target.classList.contains('node-port')) return;
        this.draggingNode = node;
        this.dragOffset = {
          x: e.clientX - node.x,
          y: e.clientY - node.y
        };
        const el = document.getElementById('node-' + node.id);
        if (el) el.classList.add('dragging');
        e.preventDefault();
      },

      // ì—°ê²° ì‹œì‘
      startConnect: function(nodeId, portType) {
        if (portType === 'output') {
          this.connecting = { fromId: nodeId, fromPort: 'output' };
        }
      },

      // ì—°ê²° ë
      endConnect: function(nodeId, portType) {
        if (this.connecting && portType === 'input' && this.connecting.fromId !== nodeId) {
          this.connect(this.connecting.fromId, nodeId);
        }
        this.connecting = null;
      },

      // ì—°ê²° ìƒì„±
      connect: function(fromId, toId) {
        // ì¤‘ë³µ ì²´í¬
        const exists = this.connections.some(c => c.from === fromId && c.to === toId);
        if (exists) return;

        // ê¸°ì¡´ ì…ë ¥ ì—°ê²° ì œê±° (í•˜ë‚˜ì˜ ì…ë ¥ë§Œ í—ˆìš©)
        this.connections = this.connections.filter(c => c.to !== toId);

        this.connections.push({ from: fromId, to: toId });
        this.renderConnections();
        this.updatePortStates();
        this.markDirty();
      },

      // í¬íŠ¸ ì—°ê²° ìƒíƒœ CSS ì—…ë°ì´íŠ¸
      updatePortStates: function() {
        // ëª¨ë“  í¬íŠ¸ì—ì„œ connected ì œê±°
        document.querySelectorAll('.node-port.connected').forEach(p => p.classList.remove('connected'));
        // ì—°ê²°ëœ í¬íŠ¸ì— connected ì¶”ê°€
        this.connections.forEach(conn => {
          const fromEl = document.getElementById('node-' + conn.from);
          const toEl = document.getElementById('node-' + conn.to);
          if (fromEl) {
            const outPort = fromEl.querySelector('.node-port-output');
            if (outPort) outPort.classList.add('connected');
          }
          if (toEl) {
            const inPort = toEl.querySelector('.node-port-input');
            if (inPort) inPort.classList.add('connected');
          }
        });
      },

      // ì—°ê²°ì„  ë Œë”ë§ (ë…¸ë“œ ì¢Œí‘œ ê¸°ë°˜ìœ¼ë¡œ ì§ì ‘ ê³„ì‚° - ë¦¬í”Œë¡œìš° ì™„ì „ íšŒí”¼)
      _connPaths: [],  // SVG path ì—˜ë¦¬ë¨¼íŠ¸ ìºì‹œ
      renderConnections: function() {
        const svg = document.getElementById('node-connections');
        const nodeWidth = 320;
        let pathIndex = 0;

        this.connections.forEach(conn => {
          const fromNode = this.nodes.find(n => n.id === conn.from);
          const toNode = this.nodes.find(n => n.id === conn.to);
          if (!fromNode || !toNode) return;

          // ìºì‹œëœ ë†’ì´ ì‚¬ìš© (ë¦¬í”Œë¡œìš° ì™„ì „ íšŒí”¼)
          const fromEl = document.getElementById('node-' + fromNode.id);
          const toEl = document.getElementById('node-' + toNode.id);
          if (!fromEl || !toEl) return;
          const fromH = fromEl._cachedHeight || 200;
          const toH = toEl._cachedHeight || 200;

          // í¬íŠ¸ ì¤‘ì‹¬ì  ì •í™• ê³„ì‚°
          // output í¬íŠ¸: right:-8px, 12px ì› â†’ ì¤‘ì‹¬ X = nodeWidth + 8 - 6 = nodeWidth + 2
          // input í¬íŠ¸: left:-8px, 12px ì› â†’ ì¤‘ì‹¬ X = -8 + 6 = -2
          // í¬íŠ¸ Y: top:50%; margin-top:-8px â†’ ì¤‘ì‹¬ = nodeHeight/2 - 8 + 8 = nodeHeight/2
          const x1 = fromNode.x + nodeWidth + 2;
          const y1 = fromNode.y + fromH * 0.5;
          const x2 = toNode.x - 2;
          const y2 = toNode.y + toH * 0.5;

          // ë¶€ë“œëŸ¬ìš´ ë² ì§€ì–´ ì»¤ë¸Œ (ìˆ˜í‰ íƒ„ì  íŠ¸)
          const dx = Math.abs(x2 - x1) * 0.5;
          const d = `M${x1},${y1} C${x1 + dx},${y1} ${x2 - dx},${y2} ${x2},${y2}`;

          let path;
          if (pathIndex < this._connPaths.length) {
            path = this._connPaths[pathIndex];
            path.setAttribute('d', d);
          } else {
            path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'node-connection');
            svg.appendChild(path);
            this._connPaths.push(path);
          }
          path.setAttribute('d', d);
          pathIndex++;
        });

        // ë‚¨ì€ path ìˆ¨ê¸°ê¸° (ì œê±° ëŒ€ì‹  ì¬ì‚¬ìš©)
        while (pathIndex < this._connPaths.length) {
          this._connPaths[pathIndex].setAttribute('d', '');
          pathIndex++;
        }
      },

      // Dirty í‘œì‹œ
      markDirty: function() {
        this.dirty = true;
        document.getElementById('node-make-btn').disabled = false;
      },

      // ë…¸ë“œ ì‚­ì œ
      deleteNode: function(nodeId) {
        this.nodes = this.nodes.filter(n => n.id !== nodeId);
        this.connections = this.connections.filter(c => c.from !== nodeId && c.to !== nodeId);
        const el = document.getElementById('node-' + nodeId);
        if (el) el.remove();
        this.renderConnections();
        if (this.selectedNode === nodeId) {
          this.selectedNode = null;
          this.updateInspector();
        }
      },

      // Make ì‹¤í–‰ (Source â†’ ë³‘ë ¬ Renderer)
      execute: async function() {
        if (!this.dirty) return;

        const makeBtn = document.getElementById('node-make-btn');
        makeBtn.disabled = true;
        makeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;animation:spin 1s linear infinite;"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Processing...';

        const self = this;

        // 1ë‹¨ê³„: Source ë…¸ë“œ ë¨¼ì € ìˆœì°¨ ì‹¤í–‰
        const sourceNodes = this.nodes.filter(n => n.type === 'source');
        for (const node of sourceNodes) {
          const el = document.getElementById('node-' + node.id);
          if (el) el.classList.add('processing');
          await this.executeSourceNode(node);
          node.dirty = false;
          if (el) el.classList.remove('processing');
          this.renderNode(node);
        }

        // 2ë‹¨ê³„: Renderer ë…¸ë“œ ë³‘ë ¬ ì‹¤í–‰
        const rendererNodes = this.nodes.filter(n => n.type === 'renderer');
        if (rendererNodes.length > 0) {
          // ëª¨ë“  ë Œë”ëŸ¬ì— processing í‘œì‹œ
          rendererNodes.forEach(node => {
            const el = document.getElementById('node-' + node.id);
            if (el) el.classList.add('processing');
          });

          // ë³‘ë ¬ ì‹¤í–‰
          const renderPromises = rendererNodes.map(node => {
            return self.executeRendererNode(node).then(() => {
              node.dirty = false;
              const el = document.getElementById('node-' + node.id);
              if (el) el.classList.remove('processing');
              self.renderNode(node);
            });
          });

          await Promise.all(renderPromises);
        }

        this.dirty = false;
        makeBtn.disabled = false;
        makeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Make';
      },

      // Source ë…¸ë“œ ì‹¤í–‰
      executeSourceNode: async function(node) {
        const self = this;
        return new Promise((resolve) => {
          // ìº¡ì²˜ ìš”ì²­
          window._nodeSourceCallback = (imageBase64) => {
            node.data.image = imageBase64;
            node.thumbnail = imageBase64;
            node.dirty = false;
            self.renderNode(node);
            self.updateInspector();
            // ë†’ì´ ë³€ê²½ í›„ ì—°ê²°ì„  ì¬ê³„ì‚°
            requestAnimationFrame(() => self.renderConnections());
            resolve();
          };
          sketchup.captureScene(state.imageSize);
          // íƒ€ì„ì•„ì›ƒ fallback
          setTimeout(() => {
            if (window._nodeSourceCallback) {
              resolve();
            }
          }, 10000);
        });
      },

      // Renderer ë…¸ë“œ ì‹¤í–‰ (ë³‘ë ¬ ì§€ì›)
      executeRendererNode: async function(node) {
        // ì…ë ¥ ì—°ê²° ì°¾ê¸°
        const inputConn = this.connections.find(c => c.to === node.id);
        if (!inputConn) return;

        const sourceNode = this.nodes.find(n => n.id === inputConn.from);
        if (!sourceNode || !sourceNode.data.image) return;

        const self = this;
        const renderId = 'node_' + node.id;

        return new Promise((resolve) => {
          // ë…¸ë“œë³„ ì½œë°± ë“±ë¡
          window._nodeRendererCallbacks[renderId] = (result) => {
            if (result.success) {
              node.thumbnail = result.image;
              node.data.image = result.image;
              self.renderNode(node);
              // ì„ íƒëœ ë…¸ë“œë©´ Inspector í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
              if (self.selectedNode === node.id) {
                self.updateInspector();
              }
              // ë†’ì´ ë³€ê²½ í›„ ì—°ê²°ì„  ì¬ê³„ì‚°
              requestAnimationFrame(() => self.renderConnections());
            } else {
              console.error('[Node] Render failed:', renderId, result.error);
            }
            resolve();
          };

          // í”„ë¡¬í”„íŠ¸ ì¡°í•©
          let prompt = node.data.customPrompt || 'Create photorealistic interior render';
          if (node.data.presets && node.data.presets.length > 0) {
            prompt += '. Style: ' + node.data.presets.join(', ');
          }
          const negPrompt = node.data.negativePrompt || '';

          // ë Œë”ë§ ìš”ì²­ (render_id í¬í•¨ â†’ Ruby Threadë¡œ ë³‘ë ¬ ì‹¤í–‰)
          sketchup.startRender(
            sourceNode.data.time,
            sourceNode.data.light,
            prompt,
            negPrompt,
            renderId
          );

          // íƒ€ì„ì•„ì›ƒ fallback (120ì´ˆ)
          setTimeout(() => {
            if (window._nodeRendererCallbacks[renderId]) {
              console.warn('[Node] Render timeout:', renderId);
              window._nodeRendererCallbacks[renderId]({ success: false, error: 'Timeout' });
            }
          }, 120000);
        });
      },

      // Topological Sort
      topologicalSort: function() {
        const result = [];
        const visited = new Set();
        const nodeMap = new Map(this.nodes.map(n => [n.id, n]));

        const visit = (nodeId) => {
          if (visited.has(nodeId)) return;
          visited.add(nodeId);

          // ì…ë ¥ ë…¸ë“œë“¤ ë¨¼ì € ë°©ë¬¸
          this.connections
            .filter(c => c.to === nodeId)
            .forEach(c => visit(c.from));

          result.push(nodeId);
        };

        this.nodes.forEach(n => visit(n.id));
        return result;
      }
    };

    // Node Editor ì´ë²¤íŠ¸
    document.getElementById('node-canvas-area').addEventListener('click', (e) => {
      if (e.target.id === 'node-canvas-area' || e.target.classList.contains('node-canvas-grid')) {
        nodeEditor.selectNode(null);
      }
    });

    // ë“œë˜ê·¸ mousemove - requestAnimationFrameìœ¼ë¡œ throttle + positionOnly ë Œë”ë§
    let _dragRafId = null;
    document.addEventListener('mousemove', (e) => {
      if (!nodeEditor.draggingNode) return;
      const nx = e.clientX - nodeEditor.dragOffset.x;
      const ny = e.clientY - nodeEditor.dragOffset.y;
      nodeEditor.draggingNode.x = nx;
      nodeEditor.draggingNode.y = ny;
      if (!_dragRafId) {
        _dragRafId = requestAnimationFrame(() => {
          nodeEditor.renderNode(nodeEditor.draggingNode, true);
          nodeEditor.renderConnections();
          _dragRafId = null;
        });
      }
    });

    document.addEventListener('mouseup', () => {
      if (_dragRafId) { cancelAnimationFrame(_dragRafId); _dragRafId = null; }
      if (nodeEditor.draggingNode) {
        const el = document.getElementById('node-' + nodeEditor.draggingNode.id);
        if (el) el.classList.remove('dragging');
      }
      nodeEditor.draggingNode = null;
      nodeEditor.connecting = null;
    });

    // íˆ´ë°” ë²„íŠ¼
    document.getElementById('node-add-source').addEventListener('click', () => {
      nodeEditor.addNode('source', 100 + Math.random() * 100, 100 + Math.random() * 100);
    });

    document.getElementById('node-add-renderer').addEventListener('click', () => {
      nodeEditor.addNode('renderer', 400 + Math.random() * 100, 100 + Math.random() * 100);
    });

    document.getElementById('node-delete').addEventListener('click', () => {
      if (nodeEditor.selectedNode) {
        nodeEditor.deleteNode(nodeEditor.selectedNode);
      }
    });

    document.getElementById('node-make-btn').addEventListener('click', () => {
      nodeEditor.execute();
    });

    // Inspector ì´ë²¤íŠ¸ - Source
    document.getElementById('inspector-source').addEventListener('click', (e) => {
      const btn = e.target.closest('[data-time], [data-light]');
      if (!btn) return;

      const node = nodeEditor.nodes.find(n => n.id === nodeEditor.selectedNode);
      if (!node) return;

      if (btn.dataset.time) {
        node.data.time = btn.dataset.time;
        node.dirty = true;
      }
      if (btn.dataset.light) {
        node.data.light = btn.dataset.light;
        node.dirty = true;
      }

      nodeEditor.markDirty();
      nodeEditor.renderNode(node);
      nodeEditor.updateInspector();
    });

    document.getElementById('node-source-capture').addEventListener('click', () => {
      const node = nodeEditor.nodes.find(n => n.id === nodeEditor.selectedNode);
      if (node && node.type === 'source') {
        nodeEditor.executeSourceNode(node);
      }
    });

    // Inspector ì´ë²¤íŠ¸ - Renderer
    document.getElementById('inspector-renderer').addEventListener('click', (e) => {
      const btn = e.target.closest('[data-res], [data-aspect], [data-preset]');
      if (!btn) return;

      const node = nodeEditor.nodes.find(n => n.id === nodeEditor.selectedNode);
      if (!node) return;

      if (btn.dataset.res) {
        node.data.resolution = btn.dataset.res;
        node.dirty = true;
      }
      if (btn.dataset.aspect) {
        node.data.aspect = btn.dataset.aspect;
        node.dirty = true;
      }
      if (btn.dataset.preset) {
        const idx = node.data.presets.indexOf(btn.dataset.preset);
        if (idx >= 0) {
          node.data.presets.splice(idx, 1);
        } else {
          node.data.presets.push(btn.dataset.preset);
        }
        node.dirty = true;
      }

      nodeEditor.markDirty();
      nodeEditor.renderNode(node);
      nodeEditor.updateInspector();
    });

    document.getElementById('node-custom-prompt').addEventListener('input', (e) => {
      const node = nodeEditor.nodes.find(n => n.id === nodeEditor.selectedNode);
      if (node && node.type === 'renderer') {
        node.data.customPrompt = e.target.value;
        node.dirty = true;
        nodeEditor.markDirty();
        nodeEditor.renderNode(node);
      }
    });

    // ì•„ì½”ë””ì–¸ í† ê¸€ ì´ë²¤íŠ¸
    document.querySelectorAll('.node-inspector-accordion-header').forEach(header => {
      header.addEventListener('click', () => {
        header.parentElement.classList.toggle('open');
      });
    });

    // Inspector íƒ­ ì´ë²¤íŠ¸ - ì»¨í…ì¸  ì „í™˜
    document.querySelectorAll('.node-inspector-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        // íƒ­ í™œì„± ìƒíƒœ
        document.querySelectorAll('.node-inspector-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        // ì»¨í…ì¸  ì „í™˜
        document.querySelectorAll('.node-preview-tab-content').forEach(c => c.classList.remove('active'));
        const content = document.querySelector('.node-preview-tab-content[data-content="' + tabName + '"]');
        if (content) content.classList.add('active');
        // Enlarge ëª¨ë“œ í™œì„±í™” ì‹œ ë™ê¸°í™”
        const enlargedPreview = document.getElementById('node-enlarged-preview');
        if (enlargedPreview.classList.contains('active')) {
          document.querySelectorAll('.node-enlarged-tab').forEach(t => t.classList.remove('active'));
          const matchTab = document.querySelector('.node-enlarged-tab[data-tab="' + tabName + '"]');
          if (matchTab) matchTab.classList.add('active');
        }
      });
    });

    // Enlarge ë²„íŠ¼ í† ê¸€
    document.getElementById('node-enlarge-btn').addEventListener('click', () => {
      const enlargedPreview = document.getElementById('node-enlarged-preview');
      const canvasArea = document.getElementById('node-canvas-area');
      const inspectorPreview = document.querySelector('.node-inspector-preview');
      const enlargeBtn = document.getElementById('node-enlarge-btn');
      const isActive = enlargedPreview.classList.toggle('active');

      canvasArea.classList.toggle('minimized', isActive);
      inspectorPreview.classList.toggle('minimap-mode', isActive);
      enlargeBtn.classList.toggle('active', isActive);

      if (isActive) {
        // í˜„ì¬ Inspector í”„ë¦¬ë·° ì´ë¯¸ì§€ë¥¼ enlargedë¡œ ë³µì‚¬
        const previewImg = document.querySelector('#node-preview-image img');
        const enlargedImage = document.getElementById('node-enlarged-image');
        if (previewImg) {
          enlargedImage.innerHTML = '<img src="' + previewImg.src + '" alt="Enlarged Preview">';
        } else {
          enlargedImage.innerHTML = '<span class="node-inspector-preview-empty">No preview</span>';
        }
        // í˜„ì¬ Inspector íƒ­ ìƒíƒœë¥¼ enlarged íƒ­ì— ë™ê¸°í™”
        const activeTab = document.querySelector('.node-inspector-tab.active');
        if (activeTab) {
          document.querySelectorAll('.node-enlarged-tab').forEach(t => t.classList.remove('active'));
          const matchTab = document.querySelector('.node-enlarged-tab[data-tab="' + activeTab.dataset.tab + '"]');
          if (matchTab) matchTab.classList.add('active');
        }
      }
    });

    // Enlarged ë·° íƒ­ ì´ë²¤íŠ¸
    document.querySelectorAll('.node-enlarged-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        // Enlarged íƒ­ í™œì„± ìƒíƒœ
        document.querySelectorAll('.node-enlarged-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        // Inspector íƒ­ë„ ë™ê¸°í™”
        document.querySelectorAll('.node-inspector-tab').forEach(t => t.classList.remove('active'));
        const matchTab = document.querySelector('.node-inspector-tab[data-tab="' + tabName + '"]');
        if (matchTab) matchTab.classList.add('active');
        // Inspector ì»¨í…ì¸ ë„ ì „í™˜
        document.querySelectorAll('.node-preview-tab-content').forEach(c => c.classList.remove('active'));
        const content = document.querySelector('.node-preview-tab-content[data-content="' + tabName + '"]');
        if (content) content.classList.add('active');
      });
    });

    // í•˜ë‹¨ í”„ë¡¬í”„íŠ¸ ë°” ì…ë ¥ ì—°ë™
    document.getElementById('node-prompt-input').addEventListener('input', (e) => {
      const node = nodeEditor.nodes.find(n => n.id === nodeEditor.selectedNode && n.type === 'renderer');
      if (node) {
        node.data.customPrompt = e.target.value;
        const inspectorPrompt = document.getElementById('node-custom-prompt');
        if (inspectorPrompt) inspectorPrompt.value = e.target.value;
        node.dirty = true;
        nodeEditor.markDirty();
      }
    });

    // Negative í”„ë¡¬í”„íŠ¸ ì—°ë™
    document.getElementById('node-prompt-negative-input').addEventListener('input', (e) => {
      const node = nodeEditor.nodes.find(n => n.id === nodeEditor.selectedNode && n.type === 'renderer');
      if (node) {
        node.data.negativePrompt = e.target.value;
        node.dirty = true;
        nodeEditor.markDirty();
      }
    });

    // Auto í”„ë¡¬í”„íŠ¸ ìƒì„± ë²„íŠ¼
    document.getElementById('node-prompt-auto-btn').addEventListener('click', () => {
      const node = nodeEditor.nodes.find(n => n.id === nodeEditor.selectedNode && n.type === 'renderer');
      if (!node) return;

      // Source ë…¸ë“œ ì°¾ê¸°
      const inputConn = nodeEditor.connections.find(c => c.to === node.id);
      if (!inputConn) return;
      const sourceNode = nodeEditor.nodes.find(n => n.id === inputConn.from);
      if (!sourceNode) return;

      const style = (node.data.presets && node.data.presets.length > 0)
        ? node.data.presets.join(', ') : '';
      const time = sourceNode.data.time || 'day';
      const light = sourceNode.data.light || 'on';

      // Auto í”„ë¡¬í”„íŠ¸ ì½œë°± ë“±ë¡
      window._nodeAutoPromptCallback = (prompt) => {
        node.data.customPrompt = prompt;
        document.getElementById('node-prompt-input').value = prompt;
        const inspectorPrompt = document.getElementById('node-custom-prompt');
        if (inspectorPrompt) inspectorPrompt.value = prompt;
        node.dirty = true;
        nodeEditor.markDirty();
        window._nodeAutoPromptCallback = null;
      };

      sketchup.generateAutoPrompt(style, time, light);
    });

    // Escape í‚¤ë¡œ Enlarge ëª¨ë“œ í•´ì œ
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const enlargedPreview = document.getElementById('node-enlarged-preview');
        if (enlargedPreview && enlargedPreview.classList.contains('active')) {
          document.getElementById('node-enlarge-btn').click();
        }
      }
    });

  </script>
</body>
</html>
