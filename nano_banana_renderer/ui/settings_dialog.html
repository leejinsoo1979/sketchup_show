<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÏÑ§Ï†ï - NanoBanana</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: #111;
      border-bottom: 1px solid #333;
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    .btn-close {
      width: 28px;
      height: 28px;
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      border-radius: 6px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-close:hover {
      background: #222;
      color: #fff;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .settings-section {
      background: #151515;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid #252525;
    }

    .settings-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #ffe033;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #888;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #1a1a1a;
      color: #e0e0e0;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #ffe033;
      box-shadow: 0 0 0 2px rgba(255, 224, 51, 0.15);
    }

    .form-input::placeholder {
      color: #666;
    }

    /* API Key Input Group */
    .api-key-input-group {
      display: flex;
      gap: 8px;
    }

    .api-key-input-group input {
      flex: 1;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #888;
      cursor: pointer;
      border-radius: 8px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: #252525;
      color: #fff;
    }

    /* Custom Dropdown */
    .custom-dropdown {
      position: relative;
      width: 100%;
    }

    .dropdown-selected {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #1a1a1a;
      color: #e0e0e0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }

    .dropdown-selected:hover {
      border-color: #444;
    }

    .dropdown-selected.open {
      border-color: #ffe033;
      box-shadow: 0 0 0 2px rgba(255, 224, 51, 0.15);
      border-radius: 8px 8px 0 0;
    }

    .dropdown-arrow {
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid #888;
      transition: transform 0.2s;
    }

    .dropdown-selected.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1a1a1a;
      border: 1px solid #ffe033;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .dropdown-menu.open {
      display: block;
    }

    .dropdown-group-label {
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 600;
      color: #ffe033;
      background: #111;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .dropdown-item {
      padding: 10px 12px;
      font-size: 13px;
      color: #e0e0e0;
      cursor: pointer;
      transition: background 0.15s;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .dropdown-item:hover {
      background: #252525;
    }

    .dropdown-item.selected {
      background: #252525;
      color: #ffe033;
    }

    .dropdown-item-name {
      font-weight: 500;
    }

    .dropdown-item-desc {
      font-size: 11px;
      color: #666;
    }

    /* Help Text */
    .help-text {
      font-size: 11px;
      color: #666;
      margin-top: 6px;
    }

    .help-link {
      color: #ffe033;
      text-decoration: none;
    }

    .help-link:hover {
      text-decoration: underline;
    }

    /* Connection Status */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      padding: 10px 12px;
      background: #111;
      border-radius: 8px;
      border: 1px solid #252525;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
    }

    .status-indicator.success {
      background: #22c55e;
    }

    .status-indicator.error {
      background: #ef4444;
    }

    .status-indicator.testing {
      background: #f59e0b;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-size: 12px;
      color: #888;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary {
      background: #252525;
      color: #e0e0e0;
      border: 1px solid #333;
    }

    .btn-secondary:hover {
      background: #333;
    }

    .btn-primary {
      background: #ffe033;
      color: #000;
    }

    .btn-primary:hover {
      background: #ffd700;
    }

    .mt-2 {
      margin-top: 16px;
    }

    /* Footer */
    .footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      padding: 16px 20px;
      background: #111;
      border-top: 1px solid #333;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <h1 class="header-title">‚öôÔ∏è ÏÑ§Ï†ï</h1>
    <button class="btn-close" id="btn-close" title="Îã´Í∏∞">‚úï</button>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- API Key Section -->
    <section class="settings-section">
      <h2 class="settings-section-title">
        üîë API Key
      </h2>

      <div class="form-group">
        <label class="form-label">Google Gemini API Key</label>
        <div class="api-key-input-group">
          <input
            type="password"
            id="api-key-input"
            class="form-input"
            placeholder="API KeyÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
          >
          <button class="btn-icon" id="btn-toggle-visibility" title="Î≥¥Í∏∞/Ïà®Í∏∞Í∏∞">
            üëÅÔ∏è
          </button>
        </div>
        <p class="help-text">
          API KeyÎäî <a href="https://aistudio.google.com/apikey" class="help-link" target="_blank">Google AI Studio</a>ÏóêÏÑú Î∞úÍ∏âÎ∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§.
        </p>
      </div>

      <div class="form-group">
        <label class="form-label">Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î™®Îç∏</label>
        <div class="custom-dropdown" id="model-dropdown">
          <div class="dropdown-selected" id="dropdown-selected">
            <span id="selected-text">Nano Banana (ÌëúÏ§Ä)</span>
            <span class="dropdown-arrow"></span>
          </div>
          <div class="dropdown-menu" id="dropdown-menu">
            <div class="dropdown-group-label">üèÜ ÌîÑÎ¶¨ÎØ∏ÏóÑ (ÏµúÍ≥† ÌíàÏßà)</div>
            <div class="dropdown-item" data-value="gemini-3-pro-image">
              <span class="dropdown-item-name">Nano Banana Pro</span>
              <span class="dropdown-item-desc">4K Ìï¥ÏÉÅÎèÑ, Thinking Ï∂îÎ°†</span>
            </div>
            <div class="dropdown-item" data-value="imagen-4.0-generate-001">
              <span class="dropdown-item-name">Imagen 4</span>
              <span class="dropdown-item-desc">Ìè¨ÌÜ†Î¶¨ÏñºÎ¶¨Ïä§Ìã± ÌíàÏßà</span>
            </div>
            <div class="dropdown-group-label">‚ö° Î∞∏Îü∞Ïä§ (Ï∂îÏ≤ú)</div>
            <div class="dropdown-item selected" data-value="gemini-2.5-flash-image">
              <span class="dropdown-item-name">Nano Banana (ÌëúÏ§Ä)</span>
              <span class="dropdown-item-desc">Îπ†Î•∏ ÏÜçÎèÑ, Ìé∏Ïßë Îä•Î†• Í≤∏ÎπÑ</span>
            </div>
            <div class="dropdown-group-label">üé® Í≥†ÏÜç/ÌäπÏàò</div>
            <div class="dropdown-item" data-value="imagen-4.0-fast-generate-001">
              <span class="dropdown-item-name">Imagen 4 Fast</span>
              <span class="dropdown-item-desc">1Ï¥à ÎØ∏Îßå Ï¥àÍ≥†ÏÜç ÏÉùÏÑ±</span>
            </div>
            <div class="dropdown-item" data-value="virtual-try-on-001">
              <span class="dropdown-item-name">Virtual Try-On</span>
              <span class="dropdown-item-desc">ÏùòÎ•ò Í∞ÄÏÉÅ ÌîºÌåÖ Ï†ÑÏö©</span>
            </div>
          </div>
        </div>
        <input type="hidden" id="model-select" value="gemini-2.5-flash-image">
        <p class="help-text">Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïóê ÏÇ¨Ïö©Ìï† Î™®Îç∏ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
      </div>

      <div class="connection-status">
        <span class="status-indicator" id="status-indicator"></span>
        <span class="status-text" id="connection-status-text">Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏ ÌïÑÏöî</span>
      </div>

      <div class="mt-2">
        <button class="btn btn-secondary" id="btn-test-connection">
          üîó Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
        </button>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <button class="btn btn-secondary" id="btn-cancel">Ï∑®ÏÜå</button>
    <button class="btn btn-primary" id="btn-save">Ï†ÄÏû•</button>
  </footer>

  <script>
    // State
    let apiKeyVisible = false;
    let originalApiKey = '';
    let dropdownOpen = false;

    // Elements
    const elements = {
      apiKeyInput: document.getElementById('api-key-input'),
      btnToggleVisibility: document.getElementById('btn-toggle-visibility'),
      btnTestConnection: document.getElementById('btn-test-connection'),
      statusIndicator: document.getElementById('status-indicator'),
      connectionStatusText: document.getElementById('connection-status-text'),
      modelSelect: document.getElementById('model-select'),
      btnSave: document.getElementById('btn-save'),
      btnCancel: document.getElementById('btn-cancel'),
      btnClose: document.getElementById('btn-close'),
      dropdownSelected: document.getElementById('dropdown-selected'),
      dropdownMenu: document.getElementById('dropdown-menu'),
      selectedText: document.getElementById('selected-text')
    };

    // Custom Dropdown
    elements.dropdownSelected.addEventListener('click', function(e) {
      e.stopPropagation();
      dropdownOpen = !dropdownOpen;
      this.classList.toggle('open', dropdownOpen);
      elements.dropdownMenu.classList.toggle('open', dropdownOpen);
    });

    document.querySelectorAll('.dropdown-item').forEach(function(item) {
      item.addEventListener('click', function(e) {
        e.stopPropagation();
        const value = this.dataset.value;
        const name = this.querySelector('.dropdown-item-name').textContent;

        // Update hidden input
        elements.modelSelect.value = value;

        // Update selected text
        elements.selectedText.textContent = name;

        // Update selected state
        document.querySelectorAll('.dropdown-item').forEach(function(i) {
          i.classList.remove('selected');
        });
        this.classList.add('selected');

        // Close dropdown
        dropdownOpen = false;
        elements.dropdownSelected.classList.remove('open');
        elements.dropdownMenu.classList.remove('open');
      });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      if (dropdownOpen) {
        dropdownOpen = false;
        elements.dropdownSelected.classList.remove('open');
        elements.dropdownMenu.classList.remove('open');
      }
    });

    // SketchUp Communication
    function callRuby(action, param) {
      if (window.sketchup && typeof window.sketchup[action] === 'function') {
        if (param !== undefined) {
          window.sketchup[action](param);
        } else {
          window.sketchup[action]();
        }
      } else {
        if (param !== undefined) {
          window.location = 'skp:' + action + '@' + encodeURIComponent(param);
        } else {
          window.location = 'skp:' + action;
        }
      }
    }

    const sketchup = {
      saveApiKey: function(key) {
        callRuby('save_api_key', key);
      },
      loadApiKey: function() {
        callRuby('load_api_key');
      },
      saveModel: function(model) {
        callRuby('save_model', model);
      },
      loadModel: function() {
        callRuby('load_model');
      },
      testConnection: function() {
        callRuby('test_connection');
      },
      closeDialog: function() {
        callRuby('close_dialog');
      }
    };

    // Ruby Callbacks
    function onApiKeyLoaded(maskedKey) {
      if (maskedKey) {
        elements.apiKeyInput.placeholder = maskedKey;
        originalApiKey = maskedKey;
      }
    }

    function onModelLoaded(model) {
      if (model) {
        elements.modelSelect.value = model;

        // Update dropdown UI
        const item = document.querySelector('.dropdown-item[data-value="' + model + '"]');
        if (item) {
          const name = item.querySelector('.dropdown-item-name').textContent;
          elements.selectedText.textContent = name;

          document.querySelectorAll('.dropdown-item').forEach(function(i) {
            i.classList.remove('selected');
          });
          item.classList.add('selected');
        }
      }
    }

    function onApiKeySaved() {
      updateStatus('success', 'Ï†ÄÏû• ÏôÑÎ£å');
      setTimeout(function() {
        sketchup.closeDialog();
      }, 500);
    }

    function onConnectionTestResult(success, message) {
      if (success) {
        updateStatus('success', 'Ïó∞Í≤∞ ÏÑ±Í≥µ: ' + message);
      } else {
        updateStatus('error', 'Ïó∞Í≤∞ Ïã§Ìå®: ' + message);
      }
    }

    // UI Functions
    function updateStatus(type, message) {
      elements.statusIndicator.className = 'status-indicator ' + type;
      elements.connectionStatusText.textContent = message;
    }

    // Event Handlers
    elements.btnToggleVisibility.addEventListener('click', function() {
      apiKeyVisible = !apiKeyVisible;
      elements.apiKeyInput.type = apiKeyVisible ? 'text' : 'password';
      this.textContent = apiKeyVisible ? 'üôà' : 'üëÅÔ∏è';
    });

    elements.btnTestConnection.addEventListener('click', function() {
      const apiKey = elements.apiKeyInput.value.trim();
      if (!apiKey) {
        updateStatus('error', 'API KeyÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
        return;
      }

      updateStatus('testing', 'Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë...');
      sketchup.saveApiKey(apiKey);

      setTimeout(function() {
        sketchup.testConnection();
      }, 500);
    });

    elements.btnSave.addEventListener('click', function() {
      const apiKey = elements.apiKeyInput.value.trim();
      const model = elements.modelSelect.value;

      if (apiKey) {
        sketchup.saveApiKey(apiKey);
      }
      sketchup.saveModel(model);

      if (!apiKey) {
        sketchup.closeDialog();
      }
    });

    elements.btnCancel.addEventListener('click', function() {
      sketchup.closeDialog();
    });

    elements.btnClose.addEventListener('click', function() {
      sketchup.closeDialog();
    });

    // Initialization
    document.addEventListener('DOMContentLoaded', function() {
      sketchup.loadApiKey();
      sketchup.loadModel();
    });
  </script>
</body>
</html>
