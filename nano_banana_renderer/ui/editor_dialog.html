<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>이미지 보정 - NanoBanana</title>
  <link rel="stylesheet" href="styles/common.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg-secondary);
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Preview Panel */
    .preview-panel {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
    }

    .canvas-wrapper {
      background: var(--bg-primary);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }

    #editor-canvas {
      display: block;
      max-width: 100%;
      max-height: calc(100vh - 200px);
    }

    /* Controls Panel */
    .controls-panel {
      width: 280px;
      background: var(--bg-primary);
      border-left: 1px solid var(--border-color);
      padding: var(--spacing-md);
      overflow-y: auto;
    }

    .controls-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--border-color);
    }

    .slider-section {
      margin-bottom: var(--spacing-lg);
    }

    .slider-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-sm);
    }

    .slider-item {
      display: flex;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .slider-label {
      width: 70px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .slider-input {
      flex: 1;
      margin: 0 var(--spacing-sm);
      -webkit-appearance: none;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      outline: none;
    }

    .slider-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }

    .slider-value {
      width: 35px;
      text-align: right;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .reset-btn {
      width: 100%;
      margin-top: var(--spacing-md);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <h1 class="header-title">✏️ 이미지 보정</h1>
    <button class="btn btn-ghost btn-icon" id="btn-close" title="닫기">✕</button>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Preview Panel -->
    <div class="preview-panel">
      <div class="canvas-wrapper">
        <canvas id="editor-canvas"></canvas>
      </div>
    </div>

    <!-- Controls Panel -->
    <div class="controls-panel">
      <h2 class="controls-title">조정</h2>

      <!-- Light Section -->
      <div class="slider-section">
        <h3 class="slider-section-title">빛</h3>

        <div class="slider-item">
          <span class="slider-label">밝기</span>
          <input type="range" class="slider-input" id="slider-brightness" min="-100" max="100" value="0">
          <span class="slider-value" id="value-brightness">0</span>
        </div>

        <div class="slider-item">
          <span class="slider-label">대비</span>
          <input type="range" class="slider-input" id="slider-contrast" min="-100" max="100" value="0">
          <span class="slider-value" id="value-contrast">0</span>
        </div>

        <div class="slider-item">
          <span class="slider-label">하이라이트</span>
          <input type="range" class="slider-input" id="slider-highlights" min="-100" max="100" value="0">
          <span class="slider-value" id="value-highlights">0</span>
        </div>

        <div class="slider-item">
          <span class="slider-label">그림자</span>
          <input type="range" class="slider-input" id="slider-shadows" min="-100" max="100" value="0">
          <span class="slider-value" id="value-shadows">0</span>
        </div>
      </div>

      <!-- Color Section -->
      <div class="slider-section">
        <h3 class="slider-section-title">색상</h3>

        <div class="slider-item">
          <span class="slider-label">온도</span>
          <input type="range" class="slider-input" id="slider-temperature" min="-100" max="100" value="0">
          <span class="slider-value" id="value-temperature">0</span>
        </div>

        <div class="slider-item">
          <span class="slider-label">색조</span>
          <input type="range" class="slider-input" id="slider-tint" min="-100" max="100" value="0">
          <span class="slider-value" id="value-tint">0</span>
        </div>

        <div class="slider-item">
          <span class="slider-label">채도</span>
          <input type="range" class="slider-input" id="slider-saturation" min="-100" max="100" value="0">
          <span class="slider-value" id="value-saturation">0</span>
        </div>

        <div class="slider-item">
          <span class="slider-label">생동감</span>
          <input type="range" class="slider-input" id="slider-vibrance" min="-100" max="100" value="0">
          <span class="slider-value" id="value-vibrance">0</span>
        </div>
      </div>

      <!-- Detail Section -->
      <div class="slider-section">
        <h3 class="slider-section-title">디테일</h3>

        <div class="slider-item">
          <span class="slider-label">선예도</span>
          <input type="range" class="slider-input" id="slider-sharpness" min="0" max="100" value="0">
          <span class="slider-value" id="value-sharpness">0</span>
        </div>
      </div>

      <button class="btn btn-secondary reset-btn" id="btn-reset">초기화</button>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <button class="btn btn-secondary" id="btn-cancel">취소</button>
    <button class="btn btn-primary" id="btn-apply">적용</button>
  </footer>

  <script>
    // Canvas & Context
    const canvas = document.getElementById('editor-canvas');
    const ctx = canvas.getContext('2d');

    // Original Image Data
    let originalImage = null;
    let originalImageData = null;

    // Adjustments
    const adjustments = {
      brightness: 0,
      contrast: 0,
      highlights: 0,
      shadows: 0,
      temperature: 0,
      tint: 0,
      saturation: 0,
      vibrance: 0,
      sharpness: 0
    };

    // Slider IDs
    const sliderIds = Object.keys(adjustments);

    // SketchUp Communication
    window.sketchup = {
      applyAdjustments: function(imageBase64) {
        window.location = 'skp:apply_adjustments@' + encodeURIComponent(imageBase64);
      },
      cancelEdit: function() {
        window.location = 'skp:cancel_edit';
      }
    };

    // Load Image (Called from Ruby)
    function loadImage(base64) {
      originalImage = new Image();
      originalImage.onload = function() {
        canvas.width = originalImage.width;
        canvas.height = originalImage.height;
        ctx.drawImage(originalImage, 0, 0);
        originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      };
      originalImage.src = 'data:image/png;base64,' + base64;
    }

    // Apply Adjustments
    function applyAdjustments() {
      if (!originalImageData) return;

      // Create copy of original image data
      const imageData = new ImageData(
        new Uint8ClampedArray(originalImageData.data),
        originalImageData.width,
        originalImageData.height
      );
      const data = imageData.data;

      for (let i = 0; i < data.length; i += 4) {
        let r = data[i];
        let g = data[i + 1];
        let b = data[i + 2];

        // Brightness
        const brightnessFactor = adjustments.brightness * 2.55;
        r += brightnessFactor;
        g += brightnessFactor;
        b += brightnessFactor;

        // Contrast
        const contrastFactor = (259 * (adjustments.contrast + 255)) / (255 * (259 - adjustments.contrast));
        r = contrastFactor * (r - 128) + 128;
        g = contrastFactor * (g - 128) + 128;
        b = contrastFactor * (b - 128) + 128;

        // Temperature (warm/cool)
        const tempFactor = adjustments.temperature * 0.5;
        r += tempFactor;
        b -= tempFactor;

        // Tint (green/magenta)
        const tintFactor = adjustments.tint * 0.3;
        g += tintFactor;

        // Saturation
        const gray = 0.2989 * r + 0.5870 * g + 0.1140 * b;
        const satFactor = 1 + (adjustments.saturation / 100);
        r = gray + (r - gray) * satFactor;
        g = gray + (g - gray) * satFactor;
        b = gray + (b - gray) * satFactor;

        // Vibrance (smart saturation)
        if (adjustments.vibrance !== 0) {
          const max = Math.max(r, g, b);
          const avg = (r + g + b) / 3;
          const vibranceFactor = (adjustments.vibrance / 100) * (1 - (max - avg) / 255);
          r = gray + (r - gray) * (1 + vibranceFactor);
          g = gray + (g - gray) * (1 + vibranceFactor);
          b = gray + (b - gray) * (1 + vibranceFactor);
        }

        // Highlights
        if (adjustments.highlights !== 0) {
          const luminance = (r + g + b) / 3;
          if (luminance > 170) {
            const highlightFactor = adjustments.highlights * 0.02;
            r += (255 - r) * highlightFactor;
            g += (255 - g) * highlightFactor;
            b += (255 - b) * highlightFactor;
          }
        }

        // Shadows
        if (adjustments.shadows !== 0) {
          const luminance = (r + g + b) / 3;
          if (luminance < 85) {
            const shadowFactor = adjustments.shadows * 0.02;
            r += r * shadowFactor;
            g += g * shadowFactor;
            b += b * shadowFactor;
          }
        }

        // Clamp values
        data[i] = Math.max(0, Math.min(255, r));
        data[i + 1] = Math.max(0, Math.min(255, g));
        data[i + 2] = Math.max(0, Math.min(255, b));
      }

      ctx.putImageData(imageData, 0, 0);

      // Simple sharpness (unsharp mask approximation)
      if (adjustments.sharpness > 0) {
        // Note: Real sharpening would require convolution, this is a simplified version
        ctx.globalAlpha = adjustments.sharpness / 200;
        ctx.drawImage(canvas, 0, 0);
        ctx.globalAlpha = 1;
      }
    }

    // Get Canvas as Base64
    function getCanvasBase64() {
      return canvas.toDataURL('image/png').split(',')[1];
    }

    // Reset All Adjustments
    function resetAdjustments() {
      sliderIds.forEach(function(id) {
        adjustments[id] = 0;
        document.getElementById('slider-' + id).value = 0;
        document.getElementById('value-' + id).textContent = '0';
      });
      applyAdjustments();
    }

    // Initialize Sliders
    sliderIds.forEach(function(id) {
      const slider = document.getElementById('slider-' + id);
      const valueDisplay = document.getElementById('value-' + id);

      slider.addEventListener('input', function() {
        adjustments[id] = parseInt(this.value);
        valueDisplay.textContent = this.value;
        applyAdjustments();
      });
    });

    // Reset Button
    document.getElementById('btn-reset').addEventListener('click', resetAdjustments);

    // Apply Button
    document.getElementById('btn-apply').addEventListener('click', function() {
      const imageBase64 = getCanvasBase64();
      sketchup.applyAdjustments(imageBase64);
    });

    // Cancel Button
    document.getElementById('btn-cancel').addEventListener('click', function() {
      sketchup.cancelEdit();
    });

    // Close Button
    document.getElementById('btn-close').addEventListener('click', function() {
      sketchup.cancelEdit();
    });
  </script>
</body>
</html>
